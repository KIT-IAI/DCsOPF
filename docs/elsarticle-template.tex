\documentclass[final,3p,times,twocolumn]{elsarticle}  % alternatively: review (more space between lines)

\input{macros.tex}

\usepackage{lineno,hyperref}
\modulolinenumbers[5]

\usepackage{cleveref}

% correct bad hyphenation here
\hyphenation{op-tical net-works semi-conduc-tor}
%\usepackage{subcaption}
\newcommand{\PaperTitle}{Analytical Uncertainty Propagation for Multi-Period Stochastic Optimal Power Flow}
\newcommand\scalemath[2]{\scalebox{#1}{\mbox{\ensuremath{\displaystyle #2}}}}

% Rebeccas comments
\newcommand{\rebecca}[1]{\textcolor{blue}{#1}}
\newcommand{\suggestion}[1]{\textcolor{magenta}{[#1]}}
\newcommand{\todo}[1]{\textcolor{orange}{[#1]}}

\journal{Journal of \LaTeX\ Templates}

%% `Elsevier LaTeX' style
\bibliographystyle{my-elsarticle-num}
%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\begin{frontmatter}

\title{\PaperTitle}

%% Group authors per affiliation:
\author[add1]{Rebecca Bauer}
\ead{rebecca.bauer@kit.edu}
\author[add1]{Tillmann~M\"uhlpfordt}
\ead{t.muehlpfordt@mailbox.org}
\author[add2]{Nicole Ludwig}
\ead{nicole.ludwig@uni-tuebingen.de}
\author[add1]{Veit Hagenmeyer}
\ead{veit.hagenmeyer@kit.edu}
\address[add1]{Institute for Automation und applied Informatics, Karlsruhe Institute of Technology}
\address[add2]{Cluster of Excellence “Machine Learning: New Perspectives for Science”, University of T\"ubingen, Germany}

\begin{abstract}

The increase in \glspl{res}, like wind or solar power, results in growing uncertainty also in transmission grids. 
This affects grid stability through fluctuating energy supply and an increased probability of overloaded lines. 
One key strategy to cope with this uncertainty is the use of distributed \glspl{ess}. 
In order to securely operate power systems containing renewables and use storage, optimization models are needed that both handle uncertainty and apply \glspl{ess}.

This paper introduces a compact dynamic stochastic chance-constrained optimal power flow~(CC-OPF) model, that minimizes generation costs and includes distributed \glspl{ess}. Assuming Gaussian uncertainty, we use affine policies to obtain a tractable, analytically exact reformulation as a \gls{socp}.
We test the new model on five different IEEE networks with varying sizes of 5, 39, 57, 118 and 300 nodes and include complexity analysis. 
The results show that the model is computationally efficient and robust with respect to constraint violation risk. The distributed energy storage system leads to more stable operation with flattened generation profiles. Storage absorbed RES uncertainty, and reduced generation cost. 
%For reproducability we provide our code and data to the research community.

\end{abstract}

\begin{keyword}
\textit{Multi-Period Optimal Power Flow, Gaussian uncertainty, distributed storage, affine policies, uncertainty}
\end{keyword}

\end{frontmatter}

\linenumbers

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%
% Introduction
%%%%%%%%%%%%%%%

\section{Introduction}

\glsresetall

Volatile renewable energy resources, such as wind, are increasingly included in power systems. Besides many benefits, these \glspl{res} bring more uncertainty into the system as they depend on fluctuating weather dynamics. This challenges the grid's reliability and leads to frequency fluctuations or RES curtailment. To cope with these new challenges, more and more research focuses on the operation of power systems under uncertainty \cite{Capitanescu12,Vrakopoulou17,Roald18,Guo18,Li17,Warrington13}. 
A central strategy to securely operate power systems under uncertainty is the inclusion of distributed \glspl{ess}. E.g. currently many grid boosters are installed in transmission grids \cite{molina_distributed_2012}; in Germany \cite{figgener_development_2021}, Europe \cite{zsiboracs_intermittent_2019} and in the world \cite{gulagi_role_2018, keck_impact_2019}. 
In contrast to conventional power plants (e.g. thermal, gas), \glspl{ess} have the advantage that it costs less, and it can store and discharge power of renewables. During the ongoing lifetime of thermal power plants it can also react much quicker to fluctuations. 

% \todo{These \glspl{ess} are useful in the grid as they their ramp limits are much lower than those of conventional generators within seconds, allowing them to react much quicker to frequency fluctuations\footnote{This study deviates slightly from this setting as we use hourly intervals for simplicity.}.}
% \todo{
% Dynamic? discrete
% thermal KWe mit ramp limits (nur bei thermal KWen) - sind noch da, sind im Übergang, Gas-KWe haben keine ramp limits
% storage gerechtfertigt - geringere Kosten und EE strom statt gas
% selbst ohne ramp limtis gilt immer noch ohne ramp constraints --> Discussion (funktioniert auch dann noch wenn keine thermal KWe mehr dabei sind)
% Quasi-stationäre schedules, dafür sind Batterien nicht ramp limited
% }

In order to tackle uncertainty in power systems together with storage, we can use DC \gls{opf}. \Gls{opf} is a standard tool for operating power systems in a way that minimizes operational costs, while respecting both the physical limits of the network such as line flow limits, and the power flow equation for system stability. The DC linearization of AC power flow is a standard approximation method \cite{wood_power_nodate}. Under stochastic uncertainty the DC OPF can be formulated as a chance-constrained OPF (CC-OPF), which is exact when assuming Gaussian uncertainty \cite{Muehlpfordt18c}. According to \cite{Warrington13}, any method including uncertainty should encompass three important aspects:
\begin{enumerate}
\itemsep0em 
	\item \label{item:forecasts} forecasts of uncertain disturbances such as feed-in from solar and wind sources, or demand;
	\item \label{item:policies} control policies for reacting to errors in forecasts;
	\item \label{item:propagation} propagation of uncertainties over time and space.
\end{enumerate}
Literature yet combines only aspects \ref{item:policies} and \ref{item:propagation}. Before we come to that, we list some applications for each aspect individually:
% Literature on what others do with respect to forecasting
For the first aspect of forecasts of uncertain disturbances current literature proposes various methods that predict entire distributions or quantiles, see e.g. \cite{Hong16} for an overview, for different renewable energy sources \cite{quatile_zhang_2020, quantile_solar_2017}. 
% Literature on what others do with respect to the control policies
For the second aspect of the control policies, affine control policies are often applied to problems related to the operation of power systems under uncertainty. These applications range from reserve planning \cite{Warrington13,Ding16,Bucher17} and dispatching in active distribution networks \cite{Fabietti17,Fabietti18}, to optimal power flow \cite{Vrakopoulou13b,Vrakopoulou17,Muehlpfordt18c,Louca16,MunozAlvarez14}, or building control \cite{Oldewurtel12}. 
Affine policies are already in use in power systems, and convince with their simple structure and their ability to split the power balance equation nicely such that it is fulfilled despite uncertainties~\cite{Muehlpfordt18c}.
% Literature on what others do with respect to propagation of uncertainty
For the third aspect of the propagation of uncertainty, efficient methods have been proposed. For example, scenario-based approaches \cite{Capitanescu12,Fabietti17,Vrakopoulou17}, and approaches employing polynomial chaos \cite{Muehlpfordt17a,Muehlpfordt16b,Muehlpfordt18c}. Other works study multi-period (propagation over time) \gls{opf} under uncertainty, but employ scenario-based or data-driven approaches~\cite{Vrakopoulou13,Vrakopoulou17b,Capitanescu12,Guo18}.

% Literature on what others do with respect to combining the three aspects
Approaches combining both affine policies and propagation over time and space are to be found in both robust and stochastic optimization. Robust optimization does not assume an underlying uncertainty distribution, hence, it cannot offer an exact reformulation. In stochastic optimization, on the other hand, there are several approaches. 
Several are multi-period \glspl{opf} with storage that assume Gaussian uncertainty, however, they often do not include CCs or affine policies. They use scenario-trees \cite{hemmati_stochastic_2016}, others look at AC power flow in a distribution network \cite{ayyagari_chance_2017}, or approximate the \glspl{cc} \cite{summers_stochastic_2015, li_analytical_2015}. While some works do offer an exact reformulation of CCs, they are either static \cite{bienstock_chance_2012}, lack storages \cite{bienstock_chance_2012, roald_analytical_2013}, or do not include affine policies \cite{sjodin_risk-mitigated_2012}.
Few approaches offer models including \glspl{cc} and a formulation into a \gls{socp}, but lack affine policies and time \cite{zhang_distributionally_2017}, look at the risk of cost functions without storage \cite{xie_distributionally_2018}, or apply different chance constraints \cite{Warrington13}. 
Most importantly, none of the existing approaches combines all three aspects using an exact reformulation of the whole problem such that the result is an equivalent formulation.
The latter approaches differ to the methodology introduced in the present paper, and often also in their problem objective. Also, many of them focus on detailed modeling of specific parts, while we hold our formulation general.


% Out approach
In the present paper, we therefore provide a computationally efficient and analytically exact model for optimal generator and storage schedules that combines all three aspects; forecasts, control policies and uncertainty propagation. Specifically, we optimize stochastic chance-constrained multi-period \gls{opf} for transmission systems that are subject to time-varying uncertainties and contain a large energy storage system. We choose to use Gaussian Processes (\gps) to describe the uncertain demand and generation, as they are well-suited to model power time series \cite{mitrentsis_probabilistic_2021}. \gps are very flexible~\cite{Roberts12} and allow a closed-form expressions of random variables. Since they consist of Gaussian distributions that stay Gaussian when passed through some linear operator (such as the linear DC OPF). This idea of "analytical reformulation" has been used in \cite{Li17}, only they focus on joint chance constraints. Several works have applied \gps to wind power forecasting~\cite{Kou13,Chen14}, solar power forecasting~\cite{Sheng18}, and electric load forecasting~\cite{Mori08,Leith04,Lloyd14,Rogers11,Blum13,McLoughlin13}. Given our modelling choice of \gps, the natural way to forecast uncertain disturbances for different time horizons is through Gaussian process regression (GPR) \cite{Rasmussen06} as it yields the desired mean and covariance for \gps. We then provide a tractable and exact reformulation of the \gls{opf} problem as a \gls{socp} by leveraging affine feedback policies, and by using the closed-form expressions for all occurring random variables. Additionally, we use different risk levels for the chance constraints -- not to be confused with the risk of the cost function \cite{hemmati_stochastic_2016}.

To the best of our knowledge there are no works that model a DC multi-period CC-OPF, with affine policies and Gaussian uncertainty, in a transmission network, that is reformulated into a tractable, analytically exact equivalent, convex \gls{socp} \emph{and} including forecast of uncertainties via Gaussian process regression. In contrast to most literature we extensively test our model on various network sizes from 5 to 300 nodes.

% Structure
The remainder of the paper is structured as follows. \Cref{sec:modelling_all} states the grid, models uncertainties as Gaussian processes, and introduces affine policies. \Cref{sec:OPF} states the yet intractable optimization problem under uncertainty. \Cref{sec:SolutionMethodology} then reformulates the \opf problem as a tractable convex optimization problem, and comments on its computational characteristics. The case studies in \Cref{sec:CaseStudy} apply the proposed optimization approach to the \textsc{ieee} 5-bus, 39-bus, 57-bus, 118-bus, and 300-bus test cases and a complexity analysis is provided. Lastly, the results are discussed in \Cref{sec:discussion}.

\section{Modelling assumptions}
\label{sec:modelling_all}

%\subsection{Grid Model}
The model of the electrical grid is at the core of the optimization. 
Let us consider a connected graph with $\nbus$ buses and $\nline$ lines 
under \dc power flow conditions 
for time instants $\mathcal{\horizon} = \{ 1, \dots, \horizon \}$.
%Note, that by this uncertainty propagates over space and time.
%the buses are indexed by $\mathcal{\nbus} =  \{1, \dots, \nbus \}$.
Every bus $i \in \mathcal{\nbus} =  \{1, \dots, \nbus \}$ can contain a disturbance $\load_i(t), i\in\mathcal{\Load}\subseteq\mathcal{\nbus}$, (i.e., load or renewables), a thermal generation unit $\gen_i(t)$, $i\in\mathcal{\Gen}\subseteq\mathcal{\nbus}$, and a storage injection unit~$\storage_i(t)$, $i\in\mathcal{\Storage}\subseteq\mathcal{\nbus}$.

We denote the power excess/deficit at node $i$ and time $t$ as
\begin{equation}
    \pnet_i(t) = \load_i(t) + \gen_i(t) + \storage_i(t),
\end{equation}
which is also the total power export/influx into/from node $i$ needed to guard the nodal power balance \cite{horsch_linear_2017}. 

In the following we will model the uncertain disturbances, as well as generation and storage that react to the disturbance and are modelled accordingly.

\subsection{Uncertain Disturbances as Gaussian Processes}
\label{sec:GP}

Uncertain disturbances are loads and volatile feed-ins from renewable energies. We denote them by~$\load_i(t)$ at bus~$i \in \mathcal{\nbus}$ and time~$t \in \mathcal{\horizon}$.
Specifically, we assume in this paper that the uncertainty is Gaussian and that the disturbances have no spatial correlation, i.e. the random variables are independent. For wind in particular Gaussianity of the prediction error is reasonable through the central limit theorem, since a large set of agglomerated wind farms has a normally distributed power output \cite{hemmati_stochastic_2016}.  This uncertain disturbance
%~$\{\load_i(t) \, \forall t \in \mathcal{\horizon}\}$ 
is the realization of a discrete-time stochastic process $\{ \rv{\load}_i(t) \: \forall t \in \mathcal{\horizon} \}$ given by\,\footnote{More precisely, $\{ \rv{\load}_i(t) \: \forall t \in \mathcal{\horizon} \}$ is only a snapshot of the overarching stochastic process $\{ \rv{\load}_i(t) \: \forall t \in \tilde{\mathcal{\horizon}} \}$, where $\tilde{\mathcal{\horizon}}$ is an infinite set, and $\mathcal{\horizon} \subset \tilde{\mathcal{\horizon}}$ a finite subset thereof.
We however neglect this subtlety for the sake of simplicity in the present paper.}
\begin{subequations}
	\label{eq:ConditionOnStochasticProcess}
	\begin{align}
	\label{eq:ConditionOnStochasticProcess_Mapping}
%	\renewcommand*{\arraystretch}{0.85}
	\scalemath{0.92}{%
		%	\vec{\rv{\load}}_i :=
		\begin{bmatrix}
		\rv\load_i(1) \\
		\rv\load_i(2) \\
		\vdots \\
		\rv\load_i(\horizon) \\
		\end{bmatrix}
		%	= \hat\load_i + \Load_i \rv\Xi_i
		= \underbrace{\begin{bmatrix}
			[\hat\load_i]_1\\
			[\hat\load_i]_2 \\
			\vdots \\
			[\hat\load_i]_{\horizon}
			\end{bmatrix}}_{=: \hat\load_i} +
		\underbrace{\begin{bmatrix}
			[\Load_i]_{11} & 0 & \hdots & 0 \\
			[\Load_i]_{21} & [\Load_i]_{22} & & 0 \\
			\vdots & & \ddots\\
			[\Load_i]_{\horizon 1} & & & [\Load_i]_{\horizon \horizon}]
			\end{bmatrix}}_{=: \Load_i} 
		\underbrace{\begin{bmatrix}
			[\rv\Xi_i]_1 \\
			[\rv\Xi_i]_2 \\
			\vdots \\
			[\rv\Xi_i]_\horizon		
			\end{bmatrix}}_{
			=: \rv\Xi_i}
		%	\quad \forall i \in \mathcal{\nbus},
	} %\quad \forall i \in \mathcal{\nbus}
	\end{align}
%
for all buses $i \in \mathcal{\nbus}$,
where $\hat\load_i \in \mathbb{R}^{\horizon}$ is the mean vector and $\Load_i \in \mathbb{R}^{\horizon \times \horizon}$ the lower-triangular, non-singular covariance matrix.
The stochastic germ~$\rv\Xi_i$ is a $\horizon$-variate Gaussian random vector whose elements are independent Gaussian random variables $[\rv\Xi_i]_j\sim\mathcal{N}(0,1)$.\,\footnote{Notice that non-singularity of $\Load_i$ means that~\eqref{eq:ConditionOnStochasticProcess_Mapping} is a one-to-one mapping between $[\rv\load_i(1), \dots,	\rv\load_i(\horizon)]^\top$ and the stochastic germ~$\rv\Xi_i$. The lower-triangularity of $\Load_i$ allows to create this mapping first for time instant $t=1$, then $t=2$, etc.\label{foot:OnetoOneMapping}}
Hence, the forecast error is Gaussian.
The lower-triangularity of $\Load_i$ means that the uncertain disturbance~$\rv\load_i(t)$ is causal, i.e. 
\begin{align}
\label{eq:UncertaintyModel}
\rv\load_i(t) = [ \hat\load_i ]_t + \sum_{k=1}^{t} [\Load_i]_{tk} [\rv\Xi_i]_k,
\end{align}
where $\rv\load_i(t)$ depends only on past and present time instants $k = 1, \dots, t$, but not on future ones.
\end{subequations}
Every uncertain disturbance is then fully described by its mean~$\ev{\rv\load_i(t)}$ and variance~$\var{\rv\load_i(t)}$, which we need to provide for the given time horizon
\begin{equation}
\label{eq:MeanVariance_Load}
\ev{\rv\load_i(t)} = [ \hat\load_i ]_t, \quad
\var{\rv\load_i(t)} = \sum_{k=1}^{t} [\Load_i]_{tk}^2.
\end{equation}



\subsection{Affine Policies}% yield Generation and Storage}

Having parametrized the uncertain disturbances in an affine fashion, the reaction of generation and storage is modelled accordingly. In particular, the latter have to to assume uncertainty themselves as uncertainty means that they can react to errors in forecasts. Otherwise, the power balance equation could not be fulfilled. Therefore, we model generation and storage analogously to the uncertainty: as realizations of (affine) random processes $\{ \rv\gen_i(t) \, \forall t \in \mathcal{\horizon} \}$ and $\{ \rv\storage_i(t) \, \forall t \in \mathcal{\horizon} \}$, respectively.

We do that by introducing \textit{affine policies} that determine how generation and storage react to the uncertain disturbances. For generation we introduce feedback of the form
\begin{subequations}
\label{eq:GenerationPolicy}
\begin{align}
\label{eq:AffineFeedback_Gen}
% \begin{bmatrix}
% \rv\gen_i(1) \\
% \vdots \\
% \rv\gen_i(\horizon)
% \end{bmatrix}
\rv\gen_i
%= \hat{\gen}_i + \Gen_{i,1} \rv{\Xi}_1 + \dots + \Gen_{i,\nbus} \rv{\Xi}_{\nbus}
= \hat{\gen}_i + \sum_{j \in \mathcal{\nbus}} \Gen_{i,j} \rv\Xi_j, \quad \forall i \in \mathcal{\nbus},
\end{align}
% OR
% \begin{align}
% \label{eq:GenerationPolicyPerBusPerTime}
% \rv\gen_i(t) = [ \hat\gen_i ]_t + \sum_{j \in \mathcal{\nbus}} \sum_{k=1}^{t} [ \Gen_{i,j} ]_{tk}  [\rv\Xi_j]_k \quad \forall i \in \mathcal{\nbus},
% \end{align}
\end{subequations}
for all time instants $t \in \mathcal{\horizon}$.\,\footnote{Notice that the control policy~\eqref{eq:AffineFeedback_Gen} is written in terms of the stochastic germs~$\rv\Xi_j$ for $j \in \mathcal{\nbus}$;
but in practice it is the realization of the uncertain disturbances $\rv\load_i(t)$ that can be measured.
It is always possible to get the realization of the stochastic germ from the realization of the uncertain disturbance, and vice versa, see Footnote~\ref{foot:OnetoOneMapping}.\label{foot:Rewriting}}
%
For this, $\hat{\gen}_i \in \mathbb{R}^{\horizon}$, and every $\Gen_{i,j} \in \mathbb{R}^{\horizon \times \horizon}$ with $j \in \mathcal{\nbus}$ is lower-triangular. 
The latter enforces the feedback to be causal, as they cannot depend on future uncertainties.
Note that the notation is structurally equivalent to~\eqref{eq:ConditionOnStochasticProcess} with the same stochastic germ.

% We introduce the same kind of feedback policy as in~\eqref{eq:AffineFeedback_Gen} for the storages, giving the Gaussian process $\rv\storage$ with $\hat{\storage}$ and $\Storage$.
We introduce the same kind of feedback policy~\eqref{eq:AffineFeedback_Gen} for the storage injections (from storage to grid)
\begin{align}
\label{eq:StoragePolicyPerBusPerTime}
% \begin{bmatrix}
% \rv\storage_i(1) \\
% \vdots \\
% \rv\storage_i(\horizon)
% \end{bmatrix}
\rv\storage_i
%= \hat{\storage}_i + \Storage_{i,1} \rv{\Xi}_1 + \dots + \Storage_{i,\nbus} \rv{\Xi}_{\nbus},
= \hat{\storage}_i + \sum_{j \in \mathcal{\nbus}} \Storage_{i,j} \rv\Xi_j,
\end{align}
% OR
% \begin{align}
% \label{eq:GenerationPolicyPerBusPerTime}
% \rv\storage_i(t) = [ \hat\storage_i ]_t + \sum_{j \in \mathcal{\nbus}} \sum_{k=1}^{t} [ \Storage_{i,j} ]_{tk}  [\rv\Xi_j]_k \quad \forall i \in \mathcal{\nbus},
% \end{align}
where $\hat{\storage}_i\in\mathcal{R}^{\horizon}$ and every $\Storage_{i,j} \in \mathbb{R}^{\horizon \times \horizon}$ with $j \in \mathcal{\nbus}$ is lower-triangular.

Having established $\load_i(t)$, $\gen_i(t)$ and $\storage_i(t)$ we can further derive closed-form expressions of the other random variables.
From storage injections $\rv\storage_i(t)$ we can directly model the actual storage states $\rv\energy_i(t)$ as discrete-time integrators
\begin{align}
\label{eq:StorageDynamics_RV}
\rv\energy_i(t+1) = \rv\energy_i(t) - h \, \rv\storage_i(t), \quad \rv\energy_i(1) = \rv\energy_i^{\textsc{ic}} \quad \forall i \in \mathcal{\nbus}.
\end{align}
Reformulating the equation towards $\rv\storage_i(t)$ the denominator $h \, \rv\storage_i(t) = \rv\energy_i(t)-\rv\energy_i(t+1)$ makes clear that $\rv\storage_i(t)$ is the discharge of storage from time $t$ to $t+1$, or the injection into the network.
In general, uncertainty also affects the initial condition~$\rv\energy_i^{\textsc{ic}}$ of storage~$i$.
For simplicity, the value of $h > 0$ subsumes the discretization time and a potential loss factor. 

Moreover, the change of generation inputs can be derived as $\Delta\rv\gen_i(\tau) = \rv\gen_i(\tau) {-} \rv\gen_i(\tau {-} 1)$ and the net power becomes $\rv\pnet_i(t) = \rv\load_i(t) + \rv\gen_i(t) + \rv\storage_i(t)$ for bus $i$. 
Lastly, using the power transfer distribution matrix $\ptdfmat$ mapping net power to line flows, the line flow can be expressed as $\rv\lineflow_j(t) = \ptdfmat_{j} [\rv\pnet_1(t), \dots, \rv\pnet_{\nbus}(t)]^\top$. 
The voltage angles are implicitly contained in the definition of the net power $\rv\pnet_i(t)$ \cite{horsch_linear_2017}.
Note that all those random variables are Gaussian processes by linearity. Hence, as such they are fully described by their mean and variance, as listed in Table~\ref{tab:Moments}.


\begin{table*}
	\centering
	\caption{Closed-form expressions for state of storage~$\rv\energy_i(t+1)$, change of inputs~$\Delta\rv\gen_i(\tau)$, and line flows~$\rv\lineflow_j(t)$.\label{tab:FunctionalDepenendencies}}
	\small
	\begin{tabular}{lll}
		\toprule
		$ \rv\lineflow_l(t) $ & $=$ & $  \displaystyle\sum_{i \in \mathcal{\nbus}} [\ptdfmat]_{li} ( [\hat\load_i]_t + [ \hat\gen_i ]_t +[ \hat\storage_i ]_t ) + \displaystyle\sum_{i \in \mathcal{\nbus}} \sum_{k=1}^{t} \Big( [\ptdfmat]_{li} [\Load_i]_{tk} + \displaystyle \sum_{j \in \mathcal{\nbus}} [\ptdfmat]_{lj} ( [\Gen_{j,i}]_{tk} + [\Storage_{j,i}]_{tk} ) \Big) [\rv\Xi_i]_k $ \\
		$\Delta\rv\gen_i(\tau)$ & $=$ & $ [\hat\gen_i]_{\tau} - [\hat\gen_i]_{\tau {-} 1} + \displaystyle \sum_{j \in \mathcal{\nbus}} \Big( [\Gen_{i,j}]_{\tau \tau} [\rv\Xi_j]_{\tau} + \displaystyle \sum_{k=1}^{\tau {-} 1} \Big( [\Gen_{i,j}]_{\tau k} - [\Gen_{i,j}]_{(\tau {-} 1) k} \Big) [\rv\Xi_j]_k \Big)$ \\
		$ \rv\energy_i(t+1)$ & $=$ & $\rv\energy_i^{\textsc{ic}} - h \displaystyle \sum_{k=1}^t [\hat\storage_i]_k - h \displaystyle \sum_{j \in \mathcal{\nbus}} \sum_{k=1}^t \Big( \displaystyle \sum_{l=k}^t [\Storage_{i,j}]_{lk} \Big) [\rv\Xi_j]_k $ \\
		\bottomrule
	\end{tabular}
\end{table*}
\begin{table*}
	\centering
	\caption{Expected value and variance of random variables from Problem~\eqref{eq:CCOPF_original} under affine policies \eqref{eq:GenerationPolicy} and \eqref{eq:StoragePolicyPerBusPerTime}.\label{tab:Moments}}
	\small
	\begin{tabular}{lll|lll}
		\toprule
		$\rv x$ & $\ev{\rv x}$ & $\var{\rv x} = \sigma^2$ & $\rv x$ & $\ev{\rv x}$ & $\var{\rv x} = \sigma^2$\\
		\midrule
		$\rv\load_i(t)$ & $[\hat\load_i]_t$ & $\displaystyle\sum_{k=1}^{t} [\Load_i]_{tk}^2$ & $\rv\lineflow_l(t)$ & $\displaystyle\sum_{i \in \mathcal{\nbus}} [\ptdfmat]_{li} ( [\hat\load_i]_t + [ \hat\gen_i ]_t +[ \hat\storage_i ]_t )$ & $ \displaystyle\sum_{i \in \mathcal{\nbus}} \displaystyle \sum_{k=1}^{t} \Big(  [\ptdfmat]_{li} [\Load_i]_{tk} + \displaystyle \sum_{j \in \mathcal{\nbus}} [\ptdfmat]_{l,j} ([\Gen_{j,i}]_{tk} + ([\Storage_{j,i}]_{tk}) \Big)^2$\\
		$\rv\gen_i(t)$ & $[ \hat\gen_i ]_t$ & $\displaystyle\sum_{j \in \mathcal{\nbus}} \displaystyle\sum_{k=1}^{t} [ \Gen_{i,j} ]_{tk}^2$ & $\Delta\rv\gen_i(\tau)$ & $[ \hat\gen_i ]_{\tau} - [ \hat\gen_i ]_{\tau{-}1}$ &  $\displaystyle\sum_{i \in \mathcal{\nbus}} \Big( [\Gen_{i,j}]_{\tau \tau}^2 {+} \sum_{k=1}^{\tau{-}1} ( [\Gen_{i,j}]_{\tau k} - [\Gen_{i,j}]_{(\tau-1) k})^2 \Big) $\\
		$\rv\storage_i(t)$ & $[ \hat\storage_i ]_t$ & $\displaystyle\sum_{j \in \mathcal{\nbus}} \displaystyle\sum_{k=1}^{t} [ \Storage_{i,j} ]_{tk}^2$ & $\rv\energy_i(t+1)$ & $\ev{\rv\energy_i^{\textsc{ic}}} - h \displaystyle \sum_{k=1}^{t} [ \hat\storage_i ]_k $	 & $\var{\rv\energy_i^{\textsc{ic}}} + h^2 \displaystyle \sum_{j \in \mathcal{\nbus}} \displaystyle \sum_{k=1}^{t} \Big(\displaystyle \sum_{l=k}^{t} [\Storage_{i,j}]_{lk} \Big)^2$ \\	
		\bottomrule
	\end{tabular}
\end{table*}


\subsection{Local and global balancing}
\label{sec:localglobal}

We have formulated the generators response to uncertainty through affine policies. Furthermore, we can specify how exactly generators react through the structure of the matrices ~$\Gen_{i,j}$, called \emph{local} and \emph{global balancing}.

In local balancing each generator $i$ reacts to every possible source of uncertainty $\rv{\Xi}_j$
Global balancing lets each generator react to the \emph{sum} of deviations and can be achieved by enforcing $\Gen_{i,1} = \hdots = \Gen_{i,\nbus}$ \cite{Muehlpfordt18c}.

% The structure of the matrices ~$\Gen_{i,j}$ in \eqref{eq:AffineFeedback_Gen} determines whether generators react locally or globally to uncertainties. Using local balancing, also called 'local balancing,, each generator $i$ reacts to every possible source of uncertainty $\rv{\Xi}_j$. In global balancing the generator can only react to the \emph{sum} of deviations and can be achieved by enforcing $\Gen_{i,1} = \hdots = \Gen_{i,\nbus}$ \cite{Muehlpfordt18c}.

% \begin{rema}[Flexibility of Policy Model \eqref{eq:AffineFeedback_Gen}]
% \label{rema:Flexibility}
%
% The structure of the matrices~$\Gen_{i,j}$ determines the ``character'' of the control policy~\eqref{eq:GenerationPolicyPerBusPerTime}.
% For example, the generic policy~\eqref{eq:GenerationPolicyPerBusPerTime} allows every generator~$i$ to react to every possible source of uncertainty $\rv{\Xi}_j$ according to the numerical values of~$\Gen_{i,j}$ (so-called local balancing \cite{??}).
% Global balancing---that is the possibility to react only to the \emph{sum} of deviations \cite{??}---can be achieved by enforcing $\Gen_{i,1} = \hdots = \Gen_{i,\nbus}$.
% Similar to \cite{Warrington13}, ``[e]xisting reserve mechanisms could be modeled by matrices [$\Gen_{i,j}$] for which only the main diagonal is populated.''
% \end{rema}

\subsection{Predicting Uncertainties with Gaussian Process Regression}
\label{sec:GPR}
%
To predict the uncertain disturbances~$\rv\load_i$, we need the mean $\hat\load_i$ and covariance matrix $\Load_i$.
Gaussian process regression (GPR) is a prediction method that yields precisely those.
GPR fits a family of functions $\mathcal{F}$ individually onto a data set $\mathcal{X}$. The posterior Gaussian process is then determined by the mean functions $\mu(t) = \mathbb{E}[\mathcal{F}(t)]$ ($t\in\mathbb{R}$) of $\mathcal{F}$ and a continuous covariance function $k(t,t')$
\footnote{$k$ is also called a \textit{kernel} and should be a positive definite function.}
, $t,t'\in\mathbb{R}$, yielding $\Load_i$.
Thereby, $k$ reflects both the variance around $\mu(t)$ for some $t$, as well as the covariance of two values for $t,t'$. We write the Gaussian process as $\mathcal{N}(\mu,k)$.
%
%
Since both $\mu$ and $k$ are continuous ($t\in\mathbb{R}$), for the prediction we can simply extract the discrete vector $\mu(t)\stackrel{\wedge}{=}\hat\load_i(t)$ and matrix $\Load_i$ by inserting all future $t\in\horizon$ into $\mu(t)$ and $(t,t')\in\horizon\times\horizon$ into $k$.
Then the Gaussian process at node $i$ is written as
\begin{equation}
    d_i = \mathcal{N}(\hat\load_i,\Load_i^2) \quad \forall i \in \nbus.
\end{equation}
%
For the kernel function $k$ we use the sum of cosine and squared exponential (i.e. RBF) with an added constant function--yielding
% \begin{equation}
%     k(x,x') = \left[ \sigma_{1}^2\cos\left(2\pi \sum_i \frac{(x-x')}{l_{1}}\right) \cdot \sigma_{2}^2 \exp{\left(-\frac{(x-x')^2}{2l_{2}^2}\right)} \right] + \sigma_{3},
% \end{equation}
\begin{equation}
\label{eq:kernel}
    k = k_{cosine} + k_{RBF} + k_{constant},
\end{equation}
with
\begin{align*}
    &k_{cosine}(x,x') & &= \sigma_{1}^2\cos\left(2\pi \sum_i \frac{(x-x')}{l_{1}}\right), \\
    &k_{RBF}(x,x')    & &= \sigma_{2}^2 \exp{\left(-\frac{(x-x')^2}{2l_{2}^2}\right)}, \\
    &k_{constant}(x,x') & &= \sigma_{3},
\end{align*}
where $\sigma_i$ is the variance and $l_i$ the lengthscale parameter. The variance determines the average distance of some $f\in\mathcal{F}$ to the mean function $\mu=\mathbb{E}[\mathcal{F}(x)]$; the lengthscale determines the length of the 'wiggles' in $f$ \cite{duvenaud_automatic_nodate}. This allows us to model periodicity as well as larger trends and smaller variations.

Having modelled all decision variables as random variables (and described how the uncertain disturbance are obtained), we can now put them all together into an optimization problem.
\vspace{1em}

%%%%%%%%%%%%%
% NEW MODEL
%%%%%%%%%%%%%

\section{Optimization problem for power systems under uncertainty}
\label{sec:OPF}

Given a network and Gaussian decision variables, we can now introduce constraints and an objective in order to formulate the optimal power flow problem. Besides limits for line flows, storage injections, states and final states, generators and change of generation, a main constraint is the power balance equation
\begin{equation}
    \sum_{i \in \mathcal{\nbus}} \rv\pnet_i(t) = 0.
\end{equation}
Note that this is not the nodal power balance equation as $\pnet$ is the excess/deficit at node $i$. 
The leading objective can be formulated as: \textit{''How can we operate generators optimally in the presence of uncertainty?''} (given storage systems) and we thus formulate the chance-constrained \opf problem as
\newcommand{\adjustCCOPF}{-10mm}
\begin{subequations} 
	\label{eq:CCOPF_original}
	\begin{align}
	\label{eq:CCOPF_original_cost}
	\underset{\rv{\gen}_i(t), \rv{\storage}_i(t)}{\operatorname{min}}~  & \sum_{t \in \mathcal{\horizon}}\sum_{i \in \mathcal{\nbus}} \ev{ f_i(\rv\gen_i(t)} \quad \mathrm{s.t.}\\
	\label{eq:CCOPF_original_PowerBalance}
	& \hspace{\adjustCCOPF} \sum_{i \in \mathcal{\nbus}} \rv\load_i(t) + \rv\gen_i(t) + \rv\storage_i(t) = 0 \\
	\label{eq:CCOPF_original_StorageDynamics}
	& \hspace{\adjustCCOPF} 	\rv\energy_i(t+1) = \rv\energy_i(t) - h \, \rv\storage_i(t), ~ \rv\energy_i(1) = \rv\energy_i^{\textsc{ic}} \\
	\label{eq:CCOPF_CCs}
	& \hspace{\adjustCCOPF} \prob{ \rv x(t) \leq \overline{x} } \geq 1 - \varepsilon,
	~ \prob{ \rv x (t) \geq \underline{x} } \geq 1 - \varepsilon  \\
	\label{eq:CCOPF_original_StdConstraint}
	& \hspace{\adjustCCOPF} 0 \leq \sqrt{\var{\rv{x}}} \leq \sigma_{\overline{\rv{x}}} \\
	& \hspace{\adjustCCOPF} \forall \rv{x} {\in} \{ \rv\lineflow_j (t), \rv\gen_i(t), 
	\Delta\rv\gen_i(\tau),\! \rv\energy_i(t {+} 1), \rv\energy_i(T), \rv\storage_i(t) \} \\
% 	& \hspace{\adjustCCOPF} \forall x {\in} \{ \lineflow_j, \gen_i, \Delta\gen_i, \energy_i, \energy_i^T, \storage_i \} \\
%	\nonumber	 
%	& \hspace{\adjustCCOPF} \qquad \qquad \qquad \qquad \qquad \qquad \qquad \qquad\rv\energy_i(t {+} 1), \rv\storage_i(t) \}
%	\\
	\nonumber
	& \hspace{\adjustCCOPF} \forall i \in \mathcal{\nbus}, \, t \in \mathcal{\horizon}, \, \tau \in \mathcal{\horizon} \setminus \{1\}, j \in \mathcal{L},
	%	& \underline{\pvar} \leq \pvar \leq \overline{\pvar}, \\
	%	& \underline{p}_l \leq p_l =  \phi \, (\pvar + \pfix) \leq \overline{p}_l,
	%	\nonumber	& \forall i \in \mathcal{\nbus}, ~ \forall j \in \mathcal{N}_l,
	\end{align}
\end{subequations}
where $\varepsilon \in (0,0.1]$ is the risk factor.\,\footnote{It is straightforward to modify Problem~\eqref{eq:CCOPF_original} to consider time-varying and quantity-depending risk levels $\varepsilon$, e.g. use $\overline\varepsilon_{\lineflow_j}(t)$ to specify the risk level for satisfying the upper limit of line $j$ at time $t$.}
% Problem explanation
Problem~\eqref{eq:CCOPF_original} minimizes the expected cost of generation over time~\eqref{eq:CCOPF_original_cost},
while satisfying the power balance~\eqref{eq:CCOPF_original_PowerBalance}
and the storage dynamics~\eqref{eq:CCOPF_original_StorageDynamics} in terms of random processes. %see~\eqref{eq:StorageDynamics_RV}
\footnote{For ease of presentation we assume the storage has already been installed and that their operation does not incur costs.}
% Engineering limits

All engineering limits are formulated with chance constraints~\eqref{eq:CCOPF_CCs}: the probability that the line flow $\rv\lineflow_j(t)$, the generation $\rv\gen_i(t)$, the generation ramp $\Delta\rv\gen_i(\tau)$, the storage $\rv\storage_i(t)$, $\rv\energy_i(t)$ are below/above their upper/lower limits shall be greater than or equal to $1 - \varepsilon$.
We add chance constraints for the terminal state of the storage, $\rv\energy_i(T)$, to allow for the storage to be at a predefined level (with high probability) at the end of the horizon. The inequality constraint~\eqref{eq:CCOPF_original_StdConstraint} allows to restrict the standard deviation of all occurring random variables. The restriction enables to reduce the variation of certain generation units to be small. Note that this model can easily be adapted to power plants without ramp constraints (e.g. gas plants), by removing the respective equations.

\begin{figure}
    \centering
    \includegraphics[width=0.55\textwidth]{figures/Input_Output_Model.png}
    \caption{Inputs and outputs of the dynamic CC-SOCP.}
    \label{fig:model_input_output}
\end{figure}

Figure \ref{fig:model_input_output} visualizes this method, where the inputs are network parameters, uncertainties and storage, the time horizon, risk parameter, and predicted wind power as Gaussian processes. The outputs are then the optimal generation (decision variable) and its costs (objective), as well as storage schedules and line flows.

% not yet here:
% And thirdly, we derive closed-form expressions of all occurring random variables, and their characterizing moments. Hence, this provides a reformulation of the original chance-constrained problem as a convex optimization problem.

\section{Reformulation of Optimization Problem}
\label{sec:SolutionMethodology}

Problem~\eqref{eq:CCOPF_original} is intractable for several reasons: the decision variables are random processes, the equality constraints are infinite-dimensional, and the chance constraints and cost function require to evaluate integrals for the chance-constraints. In order to derive an exact yet finite-dimensional reformulation of the problem and cope with the intractability issues, we exploit the problems structure and the Gaussianity of all random variables. More specifically, we reformulate the infinite-dimensional power flow equation, compute the probabilities of the chance constraints, and rephrase the cost function.

\subsection{Power Balance}
\label{sec:PowerBalance}

To adapt the optimal power flow equations we start by taking the power balance~\eqref{eq:CCOPF_original_PowerBalance} and substituting both the uncertainty model~\eqref{eq:ConditionOnStochasticProcess} and the generation/storage control policies~\eqref{eq:GenerationPolicy}. Then, the power balance is satisfied for all realizations if \cite{Muehlpfordt18c}
\begin{subequations}
	\label{eq:PowerBalance_reformulated}
	\begin{align}
	\label{eq:PowerBalance_reformulated_mean}	
	\sum_{i \in \mathcal{\nbus}} \hat\load_i + \hat\gen_i + \hat\storage_i &= 0_{\horizon}, \\
	\label{eq:PowerBalance_reformulated_var}	
	\Load_j + \sum_{i \in \mathcal{\nbus}} \Gen_{i,j} + \Storage_{i,j} &= 0_{\horizon \times \horizon}, & \forall j \in \mathcal{\nbus}.
	\end{align}
\end{subequations}
Equation~\eqref{eq:PowerBalance_reformulated_mean} ensures power balance in the absence of uncertainties, or equivalently power balance in terms of the expected value; equation~\eqref{eq:PowerBalance_reformulated_var} balances every uncertainty~$\Load_j$ by the sum of the reactions from generation and storage.

\subsection{Chance Constraints}
\label{sec:ChanceConstraints}
As all random variables occurring in Problem~\eqref{eq:CCOPF_original} are Gaussian random variables, the chance constraints can be reformulated exactly using the first two moments:
Let $\rv x$ be a Gaussian random variable with mean $\mu$ and variance $\sigma^2$.
Then for $\varepsilon \in (0,0.1]$,
\begin{subequations}
	\label{eq:CC_Reformulation}
\begin{align}
&\prob{ \rv x \leq \overline{x}} \geq 1 - \varepsilon \quad \Longleftrightarrow & \hspace{-0.6cm} \phantom{\underline{x} \leq }\,\,\mu + \lambda(\varepsilon) \sqrt{\sigma^2} \leq \overline{x}, \\
&\prob{ \underline{x} \leq \rv x } \geq 1 - \varepsilon \quad  \Longleftrightarrow & \hspace{-0.6cm} \underline{x} \leq \mu - \lambda(\varepsilon) \sqrt{\sigma^2},
\end{align}
\end{subequations}
where $\lambda(\varepsilon) = \Psi^{-1}(1 {-} \varepsilon)$, and $\Psi$ is the cumulative distribution function of a standard Gaussian random variable \cite{Bienstock14}.
Hence, all chance constraints from Problem~\eqref{eq:CCOPF_original} can be reformulated by applying relation~\eqref{eq:CC_Reformulation} with the moments from Table~\ref{tab:Moments}.
Similarly, the constraint on the standard deviation~\eqref{eq:CCOPF_original_StdConstraint} is rewritten exactly using the expressions from Table~\ref{tab:Moments}.

\subsection{Cost Function}
\label{sec:CostFunction}
To rephrase the cost function, we consider quadratic generation costs
\begin{subequations}
\label{eq:Cost_Reformulation}
\begin{align}
f_i(\rv\gen_i(t)) = \gamma_{i,2} \rv\gen_i(t)^2 + \gamma_{i,1} \rv\gen_i(t) + \gamma_{i,0},
\end{align}
with $\gamma_{i,2} > 0$ for all buses $i \in \mathcal{\nbus}$. However, for a tractable problem we need scalar values in the objective function, not stochastic variables. A common technique is to simply take the expected value. This leads to the new objective function
\begin{align}
\ev{f_i(\rv\gen_i(t))} =  f_i(\ev{\rv\gen_i(t)}) +  \gamma_{i,2}\var{\rv\gen_i(t)} .
\end{align}
\end{subequations}

\subsection{Second-Order Cone Program}

Finally, by combining the results from Sections~\ref{sec:PowerBalance}, \ref{sec:ChanceConstraints}, and \ref{sec:CostFunction}, we present a finite-dimensional and tractable reformulation of Problem~\eqref{eq:CCOPF_original}:
\begin{subequations} 
	\label{eq:SOCP}
	\begin{align}
	\underset{\substack{\hat\gen_i,\, \Gen_{i,j}, \\ \hat\storage_i,\, \Storage_{i,j} \\
	\forall i,j \in \mathcal{\nbus}}}{\operatorname{min}}~  & \sum_{t \in \mathcal{\horizon}}\sum_{i \in \mathcal{\nbus}} f_i(\ev{\rv\gen_i(t)}) +  \gamma_{i,2}\var{\rv\gen_i(t)}  \quad \mathrm{s.\,t.} \\
	\begin{split}
		&\sum_{i \in \mathcal{\nbus}} \hat\load_i + \hat\gen_i + \hat\storage_i = 0_{\horizon}\\
		&\Load_j + \sum_{i \in \mathcal{\nbus}} \Gen_{i,j} + \Storage_{i,j} = 0_{\horizon \times \horizon}, \quad  \forall j \in \mathcal{\nbus}
	\end{split} \\
	& \rv\energy_i(t+1) = \text{\{see Table \ref{tab:FunctionalDepenendencies}\}}, \quad \rv\energy_i(1) = \rv\energy_i^{\text{\textsc{ic}}} \\
	& \underline{x} \leq \ev{\rv{x}} \pm \lambda(\varepsilon) \sqrt{\var{\rv{x}}} \leq \overline{x} \\
	& \sqrt{\var{\rv{x}}} \leq \overline{x}_{\sigma} \\
	\nonumber
	& \forall \rv{x} \in \{ \rv\lineflow_j(t), \, \rv\gen_i(t), \, \Delta\rv\gen_i(\tau), \, \rv\energy_i(t+1), \,\rv\energy_i(\horizon),\, \rv\storage_i(t) \} \\
	\nonumber
	& \forall i \in \mathcal{\nbus}, \, t \in \mathcal{\horizon}, \, \tau \in \mathcal{\horizon} \setminus \{1\}, j \in \mathcal{L}.
	\end{align}
\end{subequations}
Problem~\eqref{eq:SOCP} is a second-order cone program (\socp), hence a convex optimization problem. 

Let us add two more notes on the exact solution and number of decision variables:
As a first note, the \socp provides an \emph{exact} reformulation of Problem~\eqref{eq:CCOPF_original} in the following sense: let $(\rv{\gen}_i(t)^\star, \rv\storage_i(t)^\star)$ for all $i \in \mathcal{N}$ denote the optimal solution to Problem~\eqref{eq:CCOPF_original} restricted to the affine policy~\eqref{eq:AffineFeedback_Gen}, and
let $(\hat{\gen}_i^\star, \Gen_{i,j}^\star, \hat{\storage}_i^\star, \Storage_{i,j}^\star)$ for all $i, j \in \mathcal{\nbus}$ denote the optimal solution to \socp~\eqref{eq:SOCP}.
Applying~\eqref{eq:CC_Reformulation} and~\cite[Proposition 1]{Muehlpfordt17a}, the optimal policies for Problem~\eqref{eq:CCOPF_original} are given by the optimal values of the policy \emph{parameters} via Problem~\eqref{eq:SOCP}
\begin{align}
\begin{bmatrix}
\rv\gen_i(t)^\star \\
\rv\storage_i(t)^\star
\end{bmatrix}
= 
\begin{bmatrix}
[ \hat\gen_i^\star ]_t \\
[ \hat\storage_i^\star ]_t
\end{bmatrix}
+
\sum_{j \in \mathcal{\nbus}} \sum_{k=1}^{t}
\begin{bmatrix}
[   \Gen_{i,j}^\star ]_{tk}   
\\
[   \Storage_{i,j}^\star ]_{tk}
\end{bmatrix}
[\rv\Xi_j]_k
\end{align}
for all buses $i \in \mathcal{\nbus}$ and time instants $t \in \mathcal{\horizon}$.

A second note is that, in theory, the problem is tractable and should be solved efficiently with certified optimality in case of a zero duality gap. However, in practice, large grids may be numerically challenging due to many uncertainties and long horizons $\horizon$. Therefore, it is advisable to introduce a minimum number of scalar decision variables. Specifically, assuming that no bus has both a generator \emph{and} storage, i.e. $\mathcal{\Gen} \cap \mathcal{\Storage} = \emptyset$, for a grid with $N_{\load}$ disturbances, $N_{\gen}$ generators, and $N_{\storage}$ storage systems sets the number of decision variables for local balancing to
\begin{equation}
\label{eq:DecisionVariables_local}
(N_\gen + N_\storage) \left( \horizon + N_\load \frac{\horizon (\horizon + 1)}{2} \right),
\end{equation}
for the generation/storage policies~\eqref{eq:GenerationPolicy}/\eqref{eq:StoragePolicyPerBusPerTime}
\footnote{In contrast to \cite{Warrington13}, we exploit lower-triangularity of the matrices $\Gen_{i,j}$, $\Storage_{i,j}$.}
in local balancing.
% Global balancing reduces this even more with $\mathcal{N}_d=1$ as the problem is then independent of the number of decision variables.

In global balancing, see subsection~\ref{sec:localglobal}, for both generation and storage the number of scalar decision variables reduces to
\begin{equation}
\label{eq:DecisionVariables_global}
(N_\gen + N_\storage) \left( \horizon + \frac{\horizon (\horizon + 1)}{2} \right),
\end{equation}
hence it is independent of the number of uncertainties in the grid.
The difference between the numbers~\eqref{eq:DecisionVariables_local} and~\eqref{eq:DecisionVariables_global} reflects the usual trade-off between computational tractability and complexity of the solution.

To summarize: by using affine control policies the infinite-dimensional Problem~\eqref{eq:CCOPF_original} can be written as a tractable convex optimization problem. Since all reformulations are equivalent transformations, there is no loss of information, e.g. all chance constraints from Problem~\eqref{eq:CCOPF_original} are satisfied \emph{exactly}; there is no additional conservatism. Table \ref{tab:comparison_CCOPF_SOCP} illustrates this process.

\begin{table}[ht]
\centering
\caption{Comparison of Problem \eqref{eq:CCOPF_original} and \eqref{eq:SOCP}.}
\label{tab:comparison_CCOPF_SOCP}
\begin{tabular}[t]{lcc}
\toprule
\footnotesize
& Formulation \eqref{eq:CCOPF_original} & Reformulation \eqref{eq:SOCP} \\
\midrule
Problem type    & No SOCP       & SOCP \\
\# constraints  & Infinite      & Finite \\
Solve CCs       & Integral      & Exact formulation \\
Variables       & Random process & Gaussian process \\
Convexity       & Not convex    & Convex \\
Tractability     & \textbf{No}    & \textbf{Yes} \\
\bottomrule
\end{tabular}
\end{table}%
\normalsize

\section{Case Studies}
\label{sec:CaseStudy}

We test the reformulated OPF on various standard test grids of different size. We start with examining a small network with 5 nodes (\textsc{ieee} case5) in Section \ref{sec:case5} as the solutions are easy to verify and understand. To show that the model works equally well on larger grids, we test the OPF on the 39-bus \textsc{ieee} test case in Section \ref{sec:case39}.
Finally, in Section \ref{sec:complexityAnalysis}, we perform a complexity analysis regarding computation time with the additional grids \textsc{ieee} case57, case118 and case300. 

For all networks, we test three scenarios; without storage (\caseNoStorage), with storage (\caseStorage) and with storage and variance constraints (\caseStorageWithVariance). The variance constraints are introduced by
\begin{align}
\label{eq:VarianceConstraint}
\sqrt{\var{\rv\gen_i(t)}} \leq 0.01.
\end{align}
We test different uncertain disturbances and storage sets, and compare local and global balancing. 
If not stated otherwise, the risk level for each chance constraint in Problem~\eqref{eq:CCOPF_original} is set to $\varepsilon = 5\,\%$ and local balancing is used. In the complexity analysis we use more risk levels ($\epsilon\in\{2.5\%, 5\%, 10\%\}$). 
There are no costs for storage usage; generation costs are the same for all generators. Additionally, storage systems have a prescribed final state, see constraints~\eqref{eq:CCOPF_CCs}, and a maximum capacity.

Apart from showing that the method works well, we answer (i) what importance storage has in a power system with uncertainty, (ii) how scalable our method is in terms of the number of uncertainties and storage, (iii) what influence variance constraints have, (iV) how local and global balancing differ, and (v) what influence different risk levels have.

For the wind forecasts we use a real world wind power data set from ENTSO-E \cite{de_felice_matteo_2021_4682697} that encompasses time series from 2014 to 2021. We smooth the time series with a rolling window of 10 hours and scale according to network capacities. Since the wind farms and data windows are chosen randomly, there is no spatial or temporal correlation that should be considered.

For the sake of simplicity, and without loss of generality, we use the following function to model loads with horizon~$t \in\mathcal{\horizon} = \{1,\dots,12\}$, and, for better understanding, we also use it as a simple, additional forecast for case5:
% uncertainty equation
\begin{subequations}
\label{eq:artificial_forecast}
	\begin{align}
	- [\hat{\load}_i]_t & =  \load_{i}^{\text{nom}} (1 + 0.1 \sin(2 \pi (t-1)/\horizon)), \quad \forall i \in \mathcal{\nbus},\\
	- \Load_i &= 
	\begin{cases}
	\tilde\Load_i \text{ from \eqref{eq:Results_GPVariance_matrix}}, & \forall i \in \mathcal{\Load},\\
	0_{\horizon \times \horizon}, & \forall i \in \mathcal{\nbus} \cap \mathcal{\Load},
	\end{cases}
	\end{align}
\end{subequations}
where~$\load_{i}^{\text{nom}}$ is the nominal load value taken from the case files and $\tilde\Load_i$ is given by \eqref{eq:Results_GPVariance_matrix}.

% Matrix D
\begin{figure}
	\centering
	\begin{equation}
	\label{eq:Results_GPVariance_matrix}
	\tilde\Load_i = 10^{-4}\cdot
	\scalemath{0.525}{
		\left[
		\begin{array}{cccccccccccc}
		87   & 0    & 0   & 0   & 0   & 0   & 0   & 0  & 0  & 0  & 0 & 0 \\
		176  & 20   & 0   & 0   & 0   & 0   & 0   & 0  & 0  & 0  & 0 & 0 \\
		292  & 60   & 7   & 0   & 0   & 0   & 0   & 0  & 0  & 0  & 0 & 0 \\
		434  & 124  & 26  & 3   & 0   & 0   & 0   & 0  & 0  & 0  & 0 & 0 \\
		594  & 211  & 63  & 13  & 3   & 0   & 0   & 0  & 0  & 0  & 0 & 0 \\
		764  & 321  & 123 & 31  & 13  & 3   & 0   & 0  & 0  & 0  & 0 & 0 \\
		937  & 447  & 208 & 63  & 32  & 11  & 3   & 0  & 0  & 0  & 0 & 0 \\
		1103 & 582  & 317 & 109 & 65  & 27  & 10  & 3  & 0  & 0  & 0 & 0 \\
		1257 & 718  & 447 & 172 & 116 & 55  & 26  & 10 & 3  & 0  & 0 & 0 \\
		1392 & 847  & 591 & 251 & 184 & 98  & 53  & 26 & 10 & 3  & 0 & 0 \\
		1504 & 964  & 741 & 342 & 271 & 156 & 94  & 53 & 24 & 9  & 3 & 0 \\
		1590 & 1063 & 889 & 441 & 371 & 229 & 151 & 94 & 50 & 24 & 9 & 3
		\end{array}
		\right]
	}
	\end{equation}
	\vspace{\adjustlength}
\end{figure}


% The upper generation limits are increased by $10\,\%$ compared to the nominal limit, while the line limits are lowered to $85\,\%$ of their nominal limits.
% The change in the power injections is set to $\pm 15\,\%$ of the nominal upper generation limit.
For the Gaussian process regression we need to perform a Cholesky decomposition $\Load_i$ of the covariance matrix, to which we apply whitening of $1e^{-7}$ due to slight numerical instabilities.
Gaussian process regression was implemented in Python \cite{10.5555/1593511} version 3.8.8 using GpFlow \cite{GPflow2017} based on tensorflow.
The SOCPs were implemented in Julia~\cite{Bezanson2017} version 1.6.1, and solved with \textsc{j}u\textsc{mp}~\cite{Dunning2017} and the MOSEK solver set to its default values, using a PC with an AMD Ryzen™ 7 PRO 4750U processor at 1700 Mhz and 16GB memory \cite{muhlpfordt_git_nodate}.

\subsection{\textsc{ieee} 5-bus test case}
\label{sec:case5}

Let us first apply method \eqref{eq:SOCP} to a simple test network in order to foster a good understanding of the dynamics. 
\textsc{ieee} case5 has five nodes, six lines, and two generators at buses $\mathcal{\Gen} = \{1,4\}$. We install two loads at buses $\{2,3\}$, one storage at bus $\mathcal{\Storage} = \{5\}$ and one uncertain disturbance at bus $\mathcal{\Load} = \{4\}$ that represents a wind farm, see Figure \ref{fig:case5:results_grids}. 
% The base \textsc{mva} for this and all following cases is set to $100$.

We alter the case file slightly in order to make it compatible with our method: Generators 1 and 2 are merged (by adding their capacities Pg, Qg, Qmax, Qmin, Pmax), because the program requires maximal one generator per node. 
% \todo{with generation limits of $(900, 520)$, and the quadratic generation costs coefficients are changed to $(0.01, 0.3, 0.2)$ (generator 1 is more expensive: $(0.1, 0.6, 0.2)$).}, 
And generator 5 is replaced by a storage, as each node can only contain a generator \emph{or} a storage. 
% Lastly, all branches have a fixed rateA of 400 and rateB of 0. 
All minor changes, such as cost coefficients and line ratings, can be found in Table \ref{tab:Parameters}.

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{figures/time series/case5_volatile/Wind_power_forecast_noSmoothing.png}
    \caption{GPR-fitted and forecast wind power outputs smoothed with a rolling window of 5.}
    \label{fig:wind_forecast_volatile}
\end{figure}

Besides the network, the OPF requires a second input; wind forecast in the form of Gaussian processes.
Figure \ref{fig:wind_forecast_volatile} shows the forecast of wind power for a random day of wind farm \emph{Northwind}. We selected the kernel as in equation \eqref{eq:kernel}. 
As we can see, the GPR fits the given data well, while the horizon encompasses more variance (uncertainty).

% case5 NEW loads artificial
\begin{figure}
    \begin{subfigure}[c]{\figwidth}
        \centering
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/certain_disturbance_2.jpg}
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/certain_disturbance_3.jpg}
        \includegraphics[width=0.6\textwidth, height=0.3\textwidth]{figures/time series/case5_artificial/uncertain_disturbance_4.jpg}
        \vspace{-2mm}
        \caption{Upper: certain disturbances~$-\load_{2}(t), \load_{3}(t)$ at buses $\{2,3\}$; lower: ten realizations of the uncertain disturbance~$-\rv\load_4(t)$ at bus~$4$ (dots), mean $-\ev{\rv\load_4(t)}$ (solid), and $-(\ev{\rv\load_4(t)} \pm 3\sqrt{\var{\rv\load_4(t)}})$-interval (shaded).}
        \label{fig:case5:Loads}
    \end{subfigure}
    
	\begin{subfigure}[c]{\figwidth}
		\centering
		
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/gen_u_8101.jpg}~
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/gen_u_8102.jpg}%
		
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/gen_delta_u_8151.jpg}~
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/gen_delta_u_8152.jpg}%
        
		\vspace{-2mm}		
		\caption{Upper: Power injections of generator at buses $\{1, 4\}$; lower: respective change in power injections.}
		\label{fig:case5:Generation}
	\end{subfigure}
	
	\begin{subfigure}[c]{\figwidth}
		\centering
% 		\scalebox{0.61}{\input{figures/time series/storage_s_1.png}}~	
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/storage_e_4651.jpg}~
% 		\scalebox{0.61}{\input{figures/time series/storage_s_12.png}}%
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/storage_s_8601.jpg}
		
% % 		\scalebox{0.61}{\input{figures/time series/storage_e_1.png}}~	
%         \includegraphics[width=0.35\textwidth]{figures/time series/casS39_v01_3/storage_e_1.jpg}~
% % 		\scalebox{0.61}{\input{figures/time series/storage_e_12.png}}%		
%         \includegraphics[width=0.35\textwidth]{figures/time series/casS39_v01_3/storage_e_12.jpg}%
		\vspace{-2mm}
		\caption{Left: Power injections of storage at bus $5$; right: respective change of power.}
		\label{fig:case5:Storage}
	\end{subfigure}
	\begin{subfigure}[c]{\figwidth}
	\centering
% 		\scalebox{0.61}{\input{figures/time series/line_24.png}}~	
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/line_901.jpg}
% 		\scalebox{0.61}{\input{figures/time series/line_28.png}}%
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/line_902.jpg}
% 		\scalebox{0.61}{\input{figures/time series/line_24.png}}~	
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/line_903.jpg}
% 		\scalebox{0.61}{\input{figures/time series/line_28.png}}%
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/line_904.jpg}
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/line_905.jpg}
% 		\scalebox{0.61}{\input{figures/time series/line_28.png}}%
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_artificial/line_906.jpg}
		\vspace{-2mm}		
		\caption{Line flows across all lines.}
		\label{fig:case5:LineFlows}
	\end{subfigure}
	\vspace{\adjustlength}
	\caption{\textsc{ieee} 5-bus grid: Results for cases \caseNoStorage (red), \caseStorage (blue), and \caseStorageWithVariance (green). All shown random variables~$\rv{x}$ are depicted in terms of their mean~$\ev{\rv{x}}$ (solid) and the interval $\ev{\rv{x}} \pm \lambda (0.05) \sqrt{\var{\rv{x}}}$ (shaded).}
	\label{fig:case5:results_artificial_newLoads}
\end{figure}

% case5 NEW loads volatile wind 
\begin{figure}
    \begin{subfigure}[c]{\figwidth}
        \centering
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/certain_disturbance_2.jpg}
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/certain_disturbance_3.jpg}
        \includegraphics[width=0.6\textwidth, height=0.3\textwidth]{figures/time series/case5_volatile/uncertain_disturbance_4.jpg}
        \vspace{-2mm}
        \caption{Upper: certain disturbances~$-\load_{2}(t), \load_{3}(t)$ at buses $\{2,3\}$; lower: ten realizations of the uncertain disturbance~$-\rv\load_4(t)$ at bus~$4$ (dots), mean $-\ev{\rv\load_4(t)}$ (solid), and $-(\ev{\rv\load_4(t)} \pm 3\sqrt{\var{\rv\load_4(t)}})$-interval (shaded).}
        \label{fig:case5:Loads_volatile}
    \end{subfigure}
	\begin{subfigure}[c]{\figwidth}
		\centering
% 		\scalebox{0.61}{\input{figures/time series/gen_u_37.png}}~
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/gen_u_8101.jpg}~
% 		\scalebox{0.61}{\input{figures/time series/gen_u_38.png}}%
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/gen_u_8102.jpg}%
		
% 		\scalebox{0.61}{\input{figures/time series/gen_delta_u_37.png}}~	
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/gen_delta_u_4151.jpg}~
% 		\scalebox{0.61}{\input{figures/time series/gen_delta_u_38.png}}%
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/gen_delta_u_4152.jpg}%
		\vspace{-2mm}		
		\caption{Upper: Power injections of generator at buses $\{1, 4\}$; lower: respective change in power injections.}
		\label{fig:case5:Generation_volatile}
	\end{subfigure}
	
	\begin{subfigure}[c]{\figwidth}
		\centering
% 		\scalebox{0.61}{\input{figures/time series/storage_s_1.png}}~	
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/storage_e_4651.jpg}~
% 		\scalebox{0.61}{\input{figures/time series/storage_s_12.png}}%
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/storage_s_8601.jpg}
		
% % 		\scalebox{0.61}{\input{figures/time series/storage_e_1.png}}~	
%         \includegraphics[width=0.35\textwidth]{figures/time series/casS39_v01_3/storage_e_1.jpg}~
% % 		\scalebox{0.61}{\input{figures/time series/storage_e_12.png}}%		
%         \includegraphics[width=0.35\textwidth]{figures/time series/casS39_v01_3/storage_e_12.jpg}%
		\vspace{-2mm}
		\caption{Left: Power injections of storage at bus $5$; right: respective change of power.}
		\label{fig:case5:Storage_volatile}
	\end{subfigure}
	\begin{subfigure}[c]{\figwidth}
	\centering
% 		\scalebox{0.61}{\input{figures/time series/line_24.png}}~	
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/line_901.jpg}
% 		\scalebox{0.61}{\input{figures/time series/line_28.png}}%
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/line_902.jpg}
% 		\scalebox{0.61}{\input{figures/time series/line_24.png}}~	
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/line_903.jpg}
% 		\scalebox{0.61}{\input{figures/time series/line_28.png}}%
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/line_904.jpg}
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/line_905.jpg}
% 		\scalebox{0.61}{\input{figures/time series/line_28.png}}%
        \includegraphics[width=0.45\textwidth]{figures/time series/case5_volatile/line_906.jpg}
		\vspace{-2mm}		
		\caption{Line flows across all lines.}
		\label{fig:case5:LineFlows_volatile}
	\end{subfigure}
	\vspace{\adjustlength}
	\caption{\textsc{ieee} 5-bus grid: Results for cases \caseNoStorage (red), \caseStorage (blue), and \caseStorageWithVariance (green). All shown random variables~$\rv{x}$ are depicted in terms of their mean~$\ev{\rv{x}}$ (solid) and the interval $\ev{\rv{x}} \pm \lambda (0.05) \sqrt{\var{\rv{x}}}$ (shaded).}
	\label{fig:case5:results_volatile_newLoads}
\end{figure}

\begin{figure}
	\begin{subfigure}[c]{\figwidth}
    \centering
    \includegraphics[width=0.95\textwidth]{figures/time series/case5_volatile/case5_allInOne_bars_NoStorage.jpg}
    \caption{Without storage.}
    \label{fig:case5_results_grids_NoStorage}
\end{subfigure}
\begin{subfigure}[c]{\figwidth}
    \centering
    \includegraphics[width=0.95\textwidth]{figures/time series/case5_volatile/case5_allInOne_bars_Storage.jpg}
    \caption{With storage.}
    \label{fig:case5_results_grids_Storage}
    \end{subfigure}
    \caption{\textsc{ieee} case5: Network state without (upper) and with (lower) storage at time $t=3$, with generation (dark blue), wind generation (light blue), loads (red), storage (green) and line flows (black).}
    \label{fig:case5:results_grids}
\end{figure}

% \begin{figure}
% 	\begin{subfigure}[c]{\figwidth}
%     \centering
%     \includegraphics[width=0.95\textwidth]{figures/case5_inv_newCaseFile_NoStorage_1+1_allInOne_Graph_diff_t=7.png}
%     \caption{Without storage.}
%     \label{fig:case5_results_grids_NoStorage}
% \end{subfigure}
% \begin{subfigure}[c]{\figwidth}
%     \centering
%     \includegraphics[width=0.95\textwidth]{figures/case5_inv_newCaseFile_Storage_1+1_allInOne_Graph_diff_t=7.png}
%     \caption{With storage.}
%     \label{fig:case5_results_grids_Storage}
%     \end{subfigure}
%     \caption{\textsc{ieee} case5: Network state without (upper) and with (lower) storage at time $t=3$, with generation (dark blue), wind generation (light blue), loads (red), storage (green) and line flows (black).}
%     \label{fig:case5:results_grids2}
% \end{figure}

The OPF results for the predicted horizon with artificial and real-world forecasts are given by Figures \ref{fig:case5:results_artificial_newLoads}, that we describe in detail, and by Figure \ref{fig:case5:results_volatile_newLoads}, that works analogously.
Generation, storage and line images contain several colored curves that depict the different scenarios; without storage (red), with storage (blue), and storage with variance constraints on generators (green).
Figure \ref{fig:case5:Loads} shows the loads and ten realizations of the uncertain wind generation. Note how the variance grows over time.

Generation and change in generation is given in Figure \ref{fig:case5:Generation}. Without storage (red), the generator needs to provide the difference in power between demand and wind generation. Hence, it reflects the behaviour of the sum of load and wind generation (in this case they have the same behaviour), and assumes all uncertainty of the forecast. 
% Although the generators capacity limits are not reached, its ramp limits are reached quickly, which limits the generation output.
In contrast, in the scenarios with storage \caseStorage (blue) and additional variance constraints \caseStorageWithVariance (green), the generation curves are almost constant, and do not assume much variance. Looking closely, the variance constraint almost diminishes variance for times $t=3,\dots,9$.
At the end of the horizon, generation curves go down as they have to respond with final storage constraints. 

Storage is depicted in Figure \ref{fig:case5:Storage}. Since there is a surplus of wind generation up to $t=4$, the storage is filled to its limit. Afterwards, the load surpasses generation and the storage empties. Much of the variance is absorbed by the storage;  even more so in scenario \caseStorageWithVariance due to the variance restriction of the generator.

Line flows of all six transmission lines are shown in Figure \ref{fig:case5:LineFlows}. Most obviously, they mirror the loads and uncertain wind generation. 
Without storage, all lines mirror the sum of load and wind generation. 
Upon including storage, lines $1$ and $5$ still mirror the load as they directly connect a generator with a load (see Figure \ref{fig:case5:results_grids}). The other lines are slightly smoothed as they are influenced by the storage.

Replacing the artificial wind forecast with a GPR prediction on real-world data introduces volatility (see Figure \ref{fig:case5:Loads_volatile}).
This leads to a lot more fluctuation for the generators with no storage (see Figure \ref{fig:case5:Generation_volatile}). Including storage leads again to almost constant generation. In terms of storage and line flow there are no differences; the OPF works alike in both trials (see Figures \ref{fig:case5:Storage_volatile} and \ref{fig:case5:LineFlows_volatile}).

Figure \ref{fig:case5:results_grids} visualizes the grids mean values at point $t=4$ in time, for the artificial load, without and with storage (\caseNoStorage and \caseStorage). At this point in time, storage is fully charged and the effect it has on the grids dynamics becomes clearest. 
% We do not show scenario \caseStorageWithVariance as it only differs slightly in variance to scenario \caseStorage.
Figure \ref{fig:case5_results_grids_NoStorage} does not contain storage, while Figure \ref{fig:case5_results_grids_Storage} shows \caseNoStorage with storage.
% Clearly, the generators at bus $1$ and $4$ mostly supply the loads at buses $2$ and $3$, respectively, over lines $1$ and $5$.
The effect of storage is that it drastically reduces generation, despite high load.

% \begin{figure*}
%     \centering
%     \includegraphics[width=\textwidth]{figures/case5_allInOne.jpg}
%     \caption{Network of case5 with results of all generators and storages for all scenarios: no storage (red), storage (blue) and storage with variance constraints on generators (green). \todo{single, smaller plots? Change color of load/REs from green to black/gray!}}
%     \label{fig:case5_all_in_one}
% \end{figure*}

% \begin{figure}
%     \centering
%     \includegraphics[width=0.5\textwidth]{figures/case5_allInOne_Graph.png}
%     \caption{Network of case 5 with generation (blue), load (red), and network flows (purple).}
%     \label{fig:case5_all_in_one_graph}
% \end{figure}

% casS39_v01_3 (more variance, variance constrained only at 32,33)
% \begin{figure}
% 	\centering
% 	\begin{subfigure}[c]{\figwidth}
% 		\centering
% 		\includegraphics[width=0.45\textwidth]{figures/time series/case39_v01_3/uncertain_disturbance_4.jpg}~
% 		\includegraphics[width=0.45\textwidth]{figures/time series/case39_v01_3/certain_disturbance_15.jpg}%
% 		\vspace{-2mm}		
% 		\caption{Left: ten realizations of the uncertain disturbance~$-\rv\load_4(t)$ at bus~$4$ (dots), mean $-\ev{\rv\load_4(t)}$ (solid), and $-(\ev{\rv\load_4(t)} \pm 3\sqrt{\var{\rv\load_4(t)}})$-interval (shaded); right: certain disturbance~$-\load_{15}(t)$ at bus $15$.}
% 		\label{fig:Disturbances}
% 	\end{subfigure}
	
% % casS39 reproduziert
% 	\begin{subfigure}[c]{\figwidth}
% 		\centering
% % 		\scalebox{0.61}{\input{figures/time series/gen_u_37.png}}~
%         \includegraphics[width=0.45\textwidth]{figures/time series/case39_v01_3/gen_u_33.jpg}~
% % 		\scalebox{0.61}{\input{figures/time series/gen_u_38.png}}%
%         \includegraphics[width=0.45\textwidth]{figures/time series/case39_v01_3/gen_u_32.jpg}%
		
% % 		\scalebox{0.61}{\input{figures/time series/gen_delta_u_37.png}}~	
%         \includegraphics[width=0.45\textwidth]{figures/time series/case39_v01_3/gen_delta_u_33.jpg}~
% % 		\scalebox{0.61}{\input{figures/time series/gen_delta_u_38.png}}%
%         \includegraphics[width=0.45\textwidth]{figures/time series/case39_v01_3/gen_delta_u_32.jpg}%
% 		\vspace{-2mm}		
% 		\caption{Upper: Power injections of generators at buses $i \in \{32, 33\}$ ; lower: respective change in power injections.}
% 		\label{fig:Generation}
% 	\end{subfigure}
	
% 	\begin{subfigure}[c]{\figwidth}
% 		\centering
% % 		\scalebox{0.61}{\input{figures/time series/storage_s_1.png}}~	
%         % \includegraphics[width=0.45\textwidth]{figures/time series/case39_v01_3/storage_s_1.jpg}~
% % 		\scalebox{0.61}{\input{figures/time series/storage_s_12.png}}%
%         % \includegraphics[width=0.45\textwidth]{figures/time series/case39_v01_3/storage_s_12.jpg}%
		
% % 		\scalebox{0.61}{\input{figures/time series/storage_e_1.png}}~	
%         \includegraphics[width=0.45\textwidth]{figures/time series/case39_v01_3/storage_e_1.jpg}~
% % 		\scalebox{0.61}{\input{figures/time series/storage_e_12.png}}%		
%         \includegraphics[width=0.45\textwidth]{figures/time series/case39_v01_3/storage_e_12.jpg}%
% 		\vspace{-2mm}
% 		\caption{Upper: Power injections of storages at buses $i \in \{1, 12\}$; lower: respective state of storage.}
% 		\label{fig:Storage}
% 	\end{subfigure}
% % 	\begin{subfigure}[c]{\figwidth}
% % 	\centering
% % % 		\scalebox{0.61}{\input{figures/time series/line_24.png}}~	
% %         \includegraphics[width=0.35\textwidth]{figures/time series/casS39_v01_3/line_21.jpg}~
% % % 		\scalebox{0.61}{\input{figures/time series/line_28.png}}%
% %         \includegraphics[width=0.35\textwidth]{figures/time series/casS39_v01_3/line_2.jpg}%
% % 		\vspace{-2mm}		
% % 		\caption{Line flows across lines $l \in \{2, 21\}$.}
% % 		\label{fig:LineFlows}
% % 	\end{subfigure}
% 	\vspace{\adjustlength}
% 	\caption{\textsc{ieee} 39-bus grid: Results for cases \caseNoStorage (red), \caseStorage (blue), and \caseStorageWithVariance (green). All shown random variables~$\rv{x}$ are depicted in terms of their mean~$\ev{\rv{x}}$ (solid) and the interval $\ev{\rv{x}} \pm \lambda (0.05) \sqrt{\var{\rv{x}}}$ (shaded).}
% 	\label{fig:IEEEresults}
% \end{figure}



% case39 VOLATILE
\begin{figure}
	\centering
	\vspace{3cm}
	
	\begin{subfigure}[c]{\figwidth}
		\centering
		\includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/uncertain_disturbance_4.jpg}~
		\includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/certain_disturbance_3.jpg}%
		
		\vspace{-2mm}		
		\caption{Left: ten realizations of the uncertain disturbance~$-\rv\load_4(t)$ at bus~$4$ (dots), mean $-\ev{\rv\load_4(t)}$ (solid), and $-(\ev{\rv\load_4(t)} \pm 3\sqrt{\var{\rv\load_4(t)}})$-interval (shaded); right: certain disturbance~$-\load_{3}(t)$ at bus $3$.}
		\label{fig:Disturbances}
	\end{subfigure}
	
	\begin{subfigure}[c]{\figwidth}
		\centering
        \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/gen_u_8102.jpg}~
        \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/gen_u_8104.jpg}%
		
        \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/gen_delta_u_4152.jpg}~
        \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/gen_delta_u_4154.jpg}%
        
		\vspace{-2mm}		
		\caption{Upper: Power injections of generators at buses $i \in \{2,4\}$ ; lower: respective change in power injections.}
		\label{fig:Generation}
	\end{subfigure}
	
	\begin{subfigure}[c]{\figwidth}
		\centering
        \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/storage_e_4651.jpg}~
        \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/storage_e_4654.jpg}%
		
        % \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/storage_e_46.jpg}~
        % \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/storage_e_12.jpg}%
        
		\vspace{-2mm}
		\caption{Upper: Power injections of storages at buses $i \in \{1,4\}$; lower: respective state of storage.}
		\label{fig:Storage}
	\end{subfigure}
	
	\begin{subfigure}[c]{\figwidth}
	\centering
        \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/line_914.jpg}~
        \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/line_922.jpg}%
        
		\vspace{-2mm}		
		\caption{Line flows across lines $l \in \{14,22\}$.}
		\label{fig:LineFlows}
	\end{subfigure}
	
	\vspace{\adjustlength}
	\caption{\textsc{ieee} 39-bus grid: Results for cases \caseNoStorage (red), \caseStorage (blue), and \caseStorageWithVariance (green). All shown random variables~$\rv{x}$ are depicted in terms of their mean~$\ev{\rv{x}}$ (solid) and the interval $\ev{\rv{x}} \pm \lambda (0.05) \sqrt{\var{\rv{x}}}$ (shaded).}
	\label{fig:IEEEresults}
	\vspace{3cm}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{figures/case39_grid.jpg}
    \caption{\textsc{ieee} case39: Network state without (upper) and with (lower) storage at time $t=9$, with generation (dark blue), wind generation (light blue), loads (red), storage (green) and line flows (black).}
    \label{fig:case39_grid}
\end{figure}

\subsection{\textsc{ieee} 39-bus test case}
\label{sec:case39}

After having tested method \eqref{eq:SOCP} on a small grid, we show that it works equally well on a larger grid.
The \textsc{ieee} 39-bus system has a total of 10 generators and 46 lines~\cite{Zimmerman11}, see Figure \ref{fig:case39_grid}.
We introduce seven uncertain disturbances at buses~$\mathcal{\Load} = \{4,8,16,20,21,26,27\}$, and five storages are placed at buses~$\mathcal{\Storage} =  \{1,12,14,18,28\}$.
%All numbers are given in per unit for a base \textsc{mva} of $100$.
Table~\ref{tab:Parameters} in the Appendix collects all problem-relevant parameters.

In order to check the method and see that storages have the same effect as before, we look at the optimized horizon~$\mathcal{\horizon} = \{1,\dots,12\}$ in Figure \ref{fig:IEEEresults}. The plots are fairly representative for the grid, i.e. the other components behave alike.
Load and wind generation, Figure \ref{fig:Disturbances}, only differ in size, as they are adjusted to the network parameters.
Generation, storage and line flow curves behave similarly.
More components are given in \ref{app:plots}: other loads are equivalent; remaining generators, storages and line flows behave similarly.
Hence, the method also works on this larger grid.

Figure \ref{fig:case39_grid} depicts the grid with all components and line flows. We can see that at time $t=9$ storages are filled and lines adjacent to storage are loaded heavily. Generation is less than in scenario \caseNoStorage without storage. 


% In Figure \ref{fig:case39:results_grid}


% Figure \ref{fig:Disturbances} depicts one uncertain load and one certain load, see \eqref{eq:artificial_forecast}.
% Other loads are equivalent to these up to absolute values. Note how variance grows monotonically over time. 
% In scenario \caseNoStorage, clearly, generation aligns with demand and mirrors the growing variance. Only when capacity limits are hit, the variance is zero as values are fixed.
% When storage is added in scenario \caseStorage, generation is almost constant and variance decreases notably. 
% Storage is charged when there is surplus generation for $t=1,2$, and discharged when demand is higher than generation.
% Adding variance constraints to generators $32,33$ in scenario \caseStorageWithVariance, for $t=5,\dots,8$, decreases variance for the generators and increases variance in the storages.
% The change in power generation shows that there is more movement at the generators without storage.
% \todo{Line flows: depending on place in network the line flows are reduced and flattened, or if connected to storage more volatile than before.}

\subsection{Computational complexity}
\label{sec:complexityAnalysis}

To evaluate the method in terms of scalability, we add \textsc{ieee} cases case57, case118 and case300 to the previous two and perform a complexity analysis with regard to computation time and costs.
Uncertainties are placed at the nodes with the highest load, i.e. the highest impact, and storage systems are placed randomly as placement does not influence computation time. 
We analyse the role of the network size, of the number of uncertain disturbances, of local vs. global balancing, and of storage on computation time. 
Additionally, we show how the costs differ with respect to risk levels, global vs. local balancing as defined in Section \ref{sec:localglobal} and storage. 
% 57_2: cases: time/nr unc
\begin{figure}
    \centering
    \includegraphics[width=0.50\textwidth]{figures/complexity_cases_time_identity.png}
    \caption{Computation time of all test cases with respect to the number of uncertainties and storages.}
    \label{fig:complexity_all}
\end{figure}

Figure \ref{fig:complexity_all} shows the computational complexity for all cases with one to ten uncertain loads and storage installations. While smaller cases run within seconds, the run time for larger network sizes above 57 rapidly increases to several minutes. We can compute up to 118 nodes efficiently; for a larger number of nodes Mosek runs out of space. Hence, the number of nodes drives computation time up considerably.

% 57: szenarios: time/nr unc
\begin{figure}
    \centering
    \includegraphics[width=0.55\textwidth]{figures/complexity_computation time_cases.png}
    \caption{Computation time for case57 of each scenario for local and global balancing with respect to the number of uncertainties and storage.}
    \label{fig:57_complexity_szenarios}
\end{figure}

% 39: risk levels: time/nr unc
\begin{figure}
    % \hspace{-1.5cm}
    \includegraphics[width=0.55\textwidth]{figures/39_complexity_costs_risk levels.jpg}
    \caption{\textsc{ieee} case39: Costs with respect to the different scenarios \caseNoStorage, \caseStorage and \caseStorageWithVariance, different risk levels $\epsilon\in\{2.5\%, 5\%, 10\%\}$ and local vs. global balancing.}
    \label{fig:39_complexity_risk_level}
\end{figure}

We compare the role of different scenarios and local vs. global balancing with the example of case39, in Figure \ref{fig:57_complexity_szenarios}. Clearly, local balancing takes a lot longer than global balancing. Also, storage increases computation time significantly, while adding variance constraints does not, as expected. The number of decision variables (blue points) scales linearly with the number of uncertainties plus storages, as can be seen from equation \eqref{eq:DecisionVariables_local}.
Other cases behave similarly.

Cost is the most interesting measure besides computation time. 
Figure \ref{fig:39_complexity_risk_level} shows the costs for \textsc{ieee} case57 with respect to different risk levels and local vs. global balancing. We can see that the with a growing number of uncertainties and storages the cost decreases. Global balancing seems to be slightly more expensive than local balancing, although looking at the scale values are all close. The different risk levels do not differ much in costs.

% % 5: costs: szenarios/risklevels/locglob PERCENT
% \begin{figure}
%     \centering
%     \includegraphics[width=0.45\textwidth]{figures/}
%     \caption{Percentages of cost differences for case5 from scenario \todo{S2}, risk $0.5\%$, local balancing on a logarithmic scale.}
%     \label{fig:case5:costs_log}<
% \end{figure}

% \begin{figure}
%     \centering
%     \includegraphics[width=0.45\textwidth]{figures/bars_costs_999.jpg}
%     \caption{\textsc{ieee} case39: Costs with respect to the different scenarios \caseNoStorage, \caseStorage and \caseStorageWithVariance, different risk levels $\epsilon\in\{2.5\%, 5\%, 10\%\}$ and local vs. global balancing.}
%     \label{fig:cost_case39}
% \end{figure}


% Figure \ref{fig:cost_case39} shows the cost differences for case39 in percent, for the three scenarios, as well as risk levels and global vs. local balancing. The reference value is \caseStorage with local balancing and a risk of $5\%$. The scale is logarithmic, hence the differences appear smaller. We can see that storage reduces the costs considerably, while variance constraints for the generators add to the costs. There is no large difference between local and global balancing or the risk levels.


% % 57: costs: szenarios/risklevels/locglob 
% \begin{figure}
%     \centering
%     \includegraphics[width=0.45\textwidth]{figures/57_4-4_bars_costs.jpg}
%     \caption{Costs...}
%     \label{fig:57_costs}
% \end{figure}

% \begin{figure}
% 	\centering
% %	\scalebox{0.61}{\input{figures/time series/costs_new.pgf}}
% % 	\scalebox{0.61}{\input{figures/time series/costs.png}}
% 	\includegraphics[width=0.45\textwidth]{figures/costs_casS39.jpg}	
% 	\caption{\textsc{ieee} 39-bus grid: Total cost for cases \caseNoStorage, \caseStorage, \caseStorageWithVariance for varying risk levels $\varepsilon \in \{ 2.5, 5.0, 10.0  \}\, \%$, and either local or global balancing.}
% 	\label{fig:39_costs}
% \end{figure}


% % Cost
% Figures~\ref{fig:Costs} and~\ref{fig:TurkishCosts} display the absolute cost (in $\$/$hr) for both cases and each of the three different cases is plotted for varying risk levels $\varepsilon \in \{2.5, 5.0, 10.0\}\,\%$.
% % For the same case and the same risk level the total cost for local vs. global balancing is plotted side-by-side.
% We observe the following common trends for both case studies:
% 1) For all risk levels the installation of the storages pays off; case~\caseNoStorage without any storage is considerably more expensive than the other two cases;
% 2) Global policies are more expensive than local policies for all cases, albeit the incurred costs may be acceptable. 
% %That this effect is clearer for the Turkish grid is likely due to its larger size. Especially if one considers in the local case the reduced number of decision variables (see below) and the gain in privacy as fewer information need to be shared;
% 3) Lower risk levels add only marginally to the total cost;
% 4) Also, adding the constraint~\eqref{eq:VarianceConstraint} on the standard deviation adds only marginally to the total cost.

% table risk levels
% \begin{table*}
% 	\centering
% 	\caption{\textsc{ieee} 39-bus grid: Computation time and number of decision variables for cases \caseNoStorage, \caseStorage, \caseStorageWithVariance for varying risk levels $\varepsilon \in \{ 2.5, 5.0, 10.0 \}\,\%$, and local/global balancing. \todo{include Table \ref{tab:ComputationTimes} with computation times? Not interesting for story, right? Mention that local case takes a lot longer than global and is about equal for different risk factors. Local has also a lot more decision variables (roughly x5).}}
% 	\label{tab:ComputationTimes}
% 	\begin{tabular}{l|cccccc}
% 		\toprule
% 		& \multicolumn{2}{c}{Case \caseNoStorage}
% 		& \multicolumn{2}{c}{Case \caseStorage}
% 		& \multicolumn{2}{c}{Case \caseStorageWithVariance} \\	
% 		& local & global & local & global & local & global \\
% 		\midrule
% 		$\varepsilon =$\:2.5\,\% & 5.5\,s & 0.8\,s & 19.0\,s & 1.5\,s & 20.9\,s & 1.5\,s\\
% 		$\varepsilon =$\:5.0\,\% & 5.6\,s & 0.8\,s & 20.3\,s & 1.4\,s & 18.2\,s & 1.4\,s\\
% 		$\varepsilon =$\:10.0\,\% & 5.5\,s & 0.8\,s & 19.6\,s & 1.5\,s & 19.3\,s & 1.4\,s \\		
% 		\midrule
% 		\#Dec. variables & 5580 & 900 & 8370 & 1350 & 8370 & 1350 \\		
% 		\bottomrule		
% 	\end{tabular}
% \end{table*}

% All cases

% Table \ref{tab:ComputationTimes} provides the computation  times  (mean  of  ten  consecutive  runs)  and  the  numberof  decision  variables  for  all  cases  and  varying  risk  levels,comparing local to global balancing.
% The computation times differ slightly: 
% For both cases \caseStorage and \caseStorageWithVariance, the ''computational cost'' of adding storages leads to some 3.6/2.0-fold increase in time for local/global balancing. This stems from the increased number of decision variables (see equation~\eqref{eq:DecisionVariables_local}).
% Also, global balancing pays off---computationally---more in case storage is present, whilst not adding considerably to the total cost, see Figures~\ref{fig:Costs} and \ref{fig:TurkishCosts}.



%%%%%%%%%%%%%%%
% Discussion
%%%%%%%%%%%%%%%

\section{Discussion}
\label{sec:discussion}

The main result from Sections \ref{sec:case5} and \ref{sec:case39} is that the method works equally well on various network sizes.
Moreover, we show three outcomes:
(i) Generation profiles are flattened out, hence, generation is a lot more stable with storage in use.
(ii) Costs reduce when more storage and uncertainties are in use, and generation and storage profiles are more similar. This suggests that larger networks can balance out uncertainties better, hence, they are more stable and secure.
(iii) Most of the uncertainty in the wind forecast is absorbed by storages, which means that renewable energy can be well integrated into generation planning, even if there is a lot of uncertainty.

Adding a remark about convergence, we can tell that the network does not converge in several cases: Firstly, when demand is larger than generation, as expected. Secondly, also as expected, when demand is too high in the beginning, because generators cannot ramp up fast enough as they reach their ramp limits.

From Section \ref{sec:complexityAnalysis} testing computation time and costs we can derive five results:
(i) The method is scalable up to roughly 100 nodes without any speedup (e.g. sparsity methods, contraction algorithms).
(ii) Risk levels do not influence costs or computation time.
(iii) local balancing takes a lot longer than global balancing, nevertheless reduces the costs slightly.
(iv) Computation time with respect to the number of uncertainties does not scale linearly with the number of decision variables. 
(v) Storages reduce generation costs notably.
Hence, the method works well on mid-size power grids and is fairly robust with respect to parameter variations. 

Concluding, we can say that the method is robust and performs well on mid-size networks, however, matrix sparcity and contraction algorithms offer large potential for speed-up. Additionally, storage plays a large role in cost reduction, reducing uncertainty by renewables, and stabilizing generation.
% \todo{müssen wir das mit den 100 Knoten genau so schreiben? with the method presented in this paper, however, by benefitting of sparsity quite obvious potential for larger grids, using ... can speed up the algorithm} - nochmal bei Concluding

%%%%%%%%%%%%%%%
% Conclusion
%%%%%%%%%%%%%%%

\section{Conclusions and Outlook}
\label{sec:conclusion}

We reformulate an intractable optimal power flow problem with uncertain disturbances and chance constraints into a tractable second order cone problem with exact analytical expressions. We modell all decision variables as Gaussian processes and predicted the disturbances with Gaussian process regression.
We test the approach on networks of differing sizes.
The new problem formulation with \gps capturing uncertainty gives realistic results and is computationally efficient for mid-size networks.
The model shows that uncertainty can be handled well by including storage into transmission networks. Almost all uncertainty is absorbed and little left at the generators, which allows for stable generation scheduling. 
Without storage much uncertainty is left at the generators and network control becomes a much more difficult and uncertain task.
Including storage also reduces the cost notably, even with variance constraints.

Further research should aim to adapt the method for practical use. 
As real-world networks are often very large, speeding up the algorithm is a next goal, for example by using the sparsity of matrices.
Also, one can look at non-Gaussian disturbances, or give more detail to the modelling of generators and storage. 
An interesting part will be to automate the Gaussian process regression (GPR) with large amounts of data.

%%%%%%%%%%%%%%%
% Acknowledgements
%%%%%%%%%%%%%%%

\section{Acknowledgements}

Nicole Ludwig acknowledges funding by the Deutsche Forschungsgemeinschaft (DFG, German Research Foundation) under Germany’s Excellence Strategy – EXC number 2064/1 – Project number 390727645 and the Athene Grant of the University of Tübingen.

%%%%%%%%%%%%%%%
% CRediT author statement
%%%%%%%%%%%%%%%

\section{Autors contribution}

\textbf{Rebecca Bauer (shared first author):} Data Curation, Software: GPR and parts of SOCP, Analysis, Writing: Original Draft, Review \& Editing, Visualization

% CRediT: https://www.elsevier.com/authors/policies-and-guidelines/credit-author-statement
\textbf{Tillmann Mühlpfordt (shared first author):} Conceptualization, Methodology, Software: SOCP, Validation, Analysis, Writing: Original Draft, Visualization, Supervision, Project administration

\textbf{Nicole Ludwig:} Supervision, Conceptualization, Writing: Original Draft, Review \& Editing

\textbf{Veit Hagenmeyer:} Supervision, Conceptualization, Review \& Editing, Project administration, Funding acquisition


%%%%%%%%%%%%%%%
% References
%%%%%%%%%%%%%%%

\bibliography{lit}

%%%%%%%%%%%%%%%
% Appendix
%%%%%%%%%%%%%%%

\clearpage

\appendix

\section{Parameter values for case studies}
\label{app:parameters}

% Table: parameter values for case study
% \hspace*{-1cm}
\begin{table}[h]
	\centering
	\resizebox{0.85\linewidth}{!}{%
		\centering
		\begin{minipage}{\linewidth}
			\centering
			\caption{Parameter values for case studies.}	
			\label{tab:Parameters}
			\centering	
			\begin{tabular}{p{0.45cm}llll}	
				\toprule
				\multirow{2}{2.75em}{$i \in \mathcal{\Gen}$}   &   $\underline{\gen}_i=0.0$ &   $\overline{\gen}_i =\,1.1 \overline{p}_i$ &       $\Delta \underline{\gen}_i =-0.15\overline{p}_i$ &        $\Delta \overline{\gen}_i =0.15\overline{p}_i$\\
				&      $\gamma_{i,2} = 0.01$ &      $\gamma_{i,1}=0.3$ &              $\gamma_{i,0} =0.2$ &  \\
				\midrule
				\multirow{2}{2.75em}{$i \in \mathcal{\Storage}$} &  $\underline{\energy}_i =0.0$ &  $
				\overline{\energy}_i =6.0$ &         $\underline{\storage}_i  =-10.0$ &          $\overline{\storage}_i = 10.0$\\
				% & & & $\overline{\energy}_{12} =1.5 $ \\
				& $\underline{\energy}_i^\horizon = 0.19 $ & $\overline{\energy}_i^\horizon =0.21 $ & $\ev{\rv\energy_i^{\text{\textsc{ic}}}} =2.0 $ & $\var{\rv\energy_i^{\text{\textsc{ic}}}} = 0.0$\\
				\midrule
				\multirow{1}{2.75em}{$j \in \mathcal{L}$}     & $\underline{\lineflow}_j=-0.85\overline{p}_{l,j}$ & $\overline{\lineflow}_j = 0.85 \overline{p}_{l,j}$ &  \multicolumn{2}{|c}{$\overline{p}_i$, $\overline{p}_{l,j}$ taken from case file \cite{Zimmerman11}}\\ \bottomrule
			\end{tabular}
		\end{minipage}
	}
	\vspace{\adjustlength}
\end{table}

\vspace{5mm}

% Table: parameter values for case5 kernel
% \hspace*{-1cm}
% \begin{table}[h]
% 	\centering
% 	\resizebox{0.85\linewidth}{!}{%
% 		\centering
% 		\begin{minipage}{\linewidth}
% 			\centering
% 			\caption{Parameter values for case study \ref{sec:case5} of \textsc{ieee} 5-bus test case.}	
% 			\label{tab:case5_params}
% 			\centering	
% 			\begin{tabular}{p{0.85cm}llll}	
% 				\toprule
% 				% \multirow{2}{3.75em}{kernels} & $l_1=$ & $l_2=$ &  & \\
% 				% & $\sigma_1=$ & $\sigma_2=$ & $\sigma_3=$ &  \\
% 				% \midrule
% 				\multirow{2}{2.75em}{$i \in \mathcal{\Gen}$}   &   $\underline{\gen}_i=0.0$ &   $\overline{\gen}_i =\,1.1 \overline{p}_i$ &       $\Delta \underline{\gen}_i =-0.15\overline{p}_i$ &        $\Delta \overline{\gen}_i =0.15\overline{p}_i$\\
% 				&      $\gamma_{i,2} = 0.01$ &      $\gamma_{i,1}=0.3$ &              $\gamma_{i,0} =0.2$ &  \\
% 				\midrule
% 				\multirow{2}{2.75em}{$i \in \mathcal{\Storage}$} &  $\underline{\energy}_i =0.0$ &  $
% 				\overline{\energy}_i =6.0$ &         $\underline{\storage}_i  =-10.0$ &          $\overline{\storage}_i = 10.0$\\
% 				& $\underline{\energy}_i^\horizon = 0.19 $ & $\overline{\energy}_i^\horizon =0.21 $ & $\ev{\rv\energy_i^{\text{\textsc{ic}}}} =2.0 $ & $\var{\rv\energy_i^{\text{\textsc{ic}}}} = 0.0$\\
% 				\midrule
% 				\multirow{1}{2.75em}{$j \in \mathcal{L}$}     & $\underline{\lineflow}_j=-0.85\overline{p}_{l,j}$ & $\overline{\lineflow}_j = 0.85 \overline{p}_{l,j}$ &  \multicolumn{2}{|c}{$\overline{p}_i$, $\overline{p}_{l,j}$ taken from case file \cite{Zimmerman11}}\\ \bottomrule
% 			\end{tabular}
% 		\end{minipage}
% 	}
% 	\vspace{\adjustlength}
% \end{table}

% \newpage
\clearpage

\section{Additional plots of case studies}
\label{app:plots}

% \begin{figure*}
%     \centering
%     \includegraphics[width=\textwidth]{figures/case5_allInOne.jpg}
%     \caption{Caption}
%     \label{fig:my_label}
% \end{figure*}

% \begin{figure*}
%     \centering
%     \includegraphics[width=\textwidth]{figures/case5_inv_newCaseFile_1+1_allInOne_Graph_diff_t=0.png}
%     \caption{Caption}
%     \label{fig:my_label}
% \end{figure*}

% \begin{figure*}
%     \centering
%     \includegraphics[width=\textwidth]{figures/case39_newCov_1+1_allInOne_Graph_diff_t=0.png}
%     \caption{Caption}
%     \label{fig:my_label}
% \end{figure*}

% \begin{figure*}
%     \centering
%     \includegraphics[width=\textwidth]{figures/case39_newCov_8+8_allInOne_Graph_diff_t=0.png}
%     \caption{Caption}
%     \label{fig:my_label}
% \end{figure*}

% \vspace{-6cm}

% case39 REST
\begin{figure}[h]
	\centering
    
    \begin{subfigure}[c]{\figwidth}
    \centering
        \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/gen_u_8102.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/gen_u_8106.jpg}%
    	\vspace{-2mm}	
    	\caption{Power injections of generators at buses $i \in \{2,3\}$.}
    \end{subfigure}
    
    \begin{subfigure}[c]{\figwidth}
    \centering
    	\includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/storage_e_4652.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/storage_e_4655.jpg}%
    	\vspace{-2mm}	
    	\caption{Power injections of storages at buses $i \in \{2,5\}$.}
    \end{subfigure}
    
    \begin{subfigure}[c]{\figwidth}
    \centering
        \includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/line_901.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/line_904.jpg}%
    \end{subfigure}
    
    \begin{subfigure}[c]{\figwidth}
    \centering
    	\includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/line_911.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case39_volatile/line_946.jpg}%
    	\vspace{-2mm}	
    	\caption{Power flows at lines $i\in\{1,4,11,46\}$.}
    \end{subfigure}
    	
    \vspace{2mm}	
	\vspace{\adjustlength}
	\caption{\textsc{ieee} 39-bus grid: Results for 7 uncertainties and 5 storage systems for cases \caseNoStorage (red), \caseStorage (blue), and \caseStorageWithVariance (green). All shown random variables~$\rv{x}$ are depicted in terms of their mean~$\ev{\rv{x}}$ (solid) and the interval $\ev{\rv{x}} \pm \lambda (0.05) \sqrt{\var{\rv{x}}}$ (shaded).}
\end{figure}

% \vspace{-8cm}

% case57
\begin{figure}
	\centering
    
    % generation
    \begin{subfigure}[c]{\figwidth}
    \centering
        \includegraphics[width=0.45\textwidth]{figures/time series/case57_volatile/gen_u_8104.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case57_volatile/gen_u_8107.jpg}%
    	\vspace{-2mm}	
    	\caption{Power injections of generators at buses $i \in \{4,7\}$.}
    \end{subfigure}
    
    % storage
    \begin{subfigure}[c]{\figwidth}
    \centering
    	\includegraphics[width=0.45\textwidth]{figures/time series/case57_volatile/storage_e_4651.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case57_volatile/storage_e_4654.jpg}%
    	\vspace{-2mm}	
    	\caption{Power injections of storages at buses $i \in \{1,4\}$.}
    \end{subfigure}
    
    % lines
    \begin{subfigure}[c]{\figwidth}
    \centering
        \includegraphics[width=0.45\textwidth]{figures/time series/case57_volatile/line_902.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case57_volatile/line_904.jpg}%
    \end{subfigure}
    \begin{subfigure}[c]{\figwidth}
    \centering
    	\includegraphics[width=0.45\textwidth]{figures/time series/case57_volatile/line_908.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case57_volatile/line_933.jpg}%
    	\vspace{-2mm}	
    	\caption{Power flows at lines $i\in\{2,4,8,33\}$.}
    \end{subfigure}
    	
    \vspace{2mm}	
	\vspace{\adjustlength}
	\caption{\textsc{ieee} 57-bus grid: Results for 7 uncertainties and 5 storage systems for cases \caseNoStorage (red), \caseStorage (blue), and \caseStorageWithVariance (green). All shown random variables~$\rv{x}$ are depicted in terms of their mean~$\ev{\rv{x}}$ (solid) and the interval $\ev{\rv{x}} \pm \lambda (0.05) \sqrt{\var{\rv{x}}}$ (shaded).}
\end{figure}

\newpage

% case118
\begin{figure}
	\centering
	
    \begin{subfigure}[c]{\figwidth}
    \centering
        \includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/gen_u_4105.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/gen_u_4106.jpg}%
    	
    	\includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/gen_u_4117.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/gen_u_4137.jpg}%
    	\vspace{-2mm}	
    	\caption{Power injections of generators at buses $i \in \{5,6,17,37\}$.}
    \end{subfigure}
    
    % \begin{subfigure}[c]{\figwidth}
    % \centering
    %     \includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/gen_u_4104.jpg}~
    % 	\includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/gen_u_4107.jpg}%
    % 	\caption{Generators without bounds}
    % \end{subfigure}
    
    \begin{subfigure}[c]{\figwidth}
    \centering
    	\includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/storage_e_4651.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/storage_e_4654.jpg}%
    	\vspace{-2mm}	
    	\caption{Power injections of storages at buses $i \in \{1,4\}$.}
    \end{subfigure}
    
    % \begin{subfigure}[c]{\figwidth}
    % \centering
    %     \includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/line_902.jpg}~
    % 	\includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/line_904.jpg}%
    % \end{subfigure}
    
    % \begin{subfigure}[c]{\figwidth}
    % \centering
    % 	\includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/line_908.jpg}~
    % 	\includegraphics[width=0.45\textwidth]{figures/time series/case118_volatile/line_933.jpg}%
    % 	\caption{Lines}
    % \end{subfigure}
    
    \vspace{2mm}	
	\vspace{\adjustlength}
	\caption{\textsc{ieee} 118-bus grid: Results for 10 uncertainties and 5 storage systems cases \caseNoStorage (red), \caseStorage (blue), and \caseStorageWithVariance (green). All shown random variables~$\rv{x}$ are depicted in terms of their mean~$\ev{\rv{x}}$ (solid) and the interval $\ev{\rv{x}} \pm \lambda (0.05) \sqrt{\var{\rv{x}}}$ (shaded).}
\end{figure}

% case300
\begin{figure}
	\centering
	
    \begin{subfigure}[c]{\figwidth}
        \centering
        \includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/gen_u_4108.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/gen_u_4111.jpg}%
    	
        \includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/gen_u_4124.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/gen_u_4140.jpg}%
    	\vspace{-2mm}	
    	\caption{Power injections of generators at buses $i \in \{8,11,24,40\}$.}
    \end{subfigure}
    
    % \begin{subfigure}[c]{\figwidth}
    % \centering
    %     \includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/gen_u_8104.jpg}~
    % 	\includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/gen_u_8107.jpg}%
    % 	\caption{Generators without bounds}
    % \end{subfigure}
    
    \begin{subfigure}[c]{\figwidth}
    \centering
    	\includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/storage_e_4651.jpg}~
    	\includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/storage_e_4654.jpg}%
    	\vspace{-2mm}	
    	\caption{Power injections of storages at buses $i \in \{1,4\}$}
    \end{subfigure}
    
    % \begin{subfigure}[c]{\figwidth}
    % \centering
    %     \includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/line_902.jpg}~
    % 	\includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/line_904.jpg}%
    % \end{subfigure}
    
    % \begin{subfigure}[c]{\figwidth}
    % \centering
    % 	\includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/line_908.jpg}~
    % 	\includegraphics[width=0.45\textwidth]{figures/time series/case300_volatile/line_933.jpg}%
    % 	\caption{Lines}
    % \end{subfigure}
    \vspace{2mm}	
	\vspace{\adjustlength}
	\caption{\textsc{ieee} 300-bus grid: Results for 4 uncertainties and 4 storage systems for cases \caseNoStorage (red), \caseStorage (blue), and \caseStorageWithVariance (green). All shown random variables~$\rv{x}$ are depicted in terms of their mean~$\ev{\rv{x}}$ (solid) and the interval $\ev{\rv{x}} \pm \lambda (0.05) \sqrt{\var{\rv{x}}}$ (shaded).}
\end{figure}

\end{document}